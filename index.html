<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Luxury House â€” Quote & Order System</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LuxuryHouse">
<link rel="apple-touch-icon" href="https://via.placeholder.com/192">
<style>
  :root {
    --red: #c0392b; --red-dark: #922b21; --red-light: #e74c3c;
    --bg: #181818; --black2: #1e1e1e; --black3: #262626; --black4: #303030;
    --border: #3a3a3a; --text: #f0f0f0; --text-muted: #999;
    --gold: #c9a84c; --success: #27ae60; --warning: #f39c12; --info: #2980b9;
    --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  header { background: linear-gradient(135deg, #0d0d0d 0%, #1a0404 100%); border-bottom: 2px solid var(--red-dark); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 62px; position: sticky; top: 0; z-index: 100; }
  .logo-icon { width: 36px; height: 36px; background: var(--red); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 10px; }
  .logo { display: flex; align-items: center; }
  .logo-text { font-size: 15px; color: #fff; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
  .logo-sub { font-size: 9px; color: var(--text-muted); letter-spacing: 1px; }
  nav { display: flex; }
  .nav-btn { background: none; border: none; color: var(--text-muted); font-size: 12px; padding: 8px 14px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; font-family: inherit; }
  .nav-btn.active { color: var(--red-light); border-bottom-color: var(--red-light); }

  main { max-width: 1100px; margin: 0 auto; padding: 20px 14px; }
  .page { display: none; } .page.active { display: block; }

  .card { background: var(--black2); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 18px; }
  .card-title { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--red-light); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); }
  input, select, textarea { background: var(--black4); border: 1px solid var(--border); color: var(--text); padding: 10px 13px; border-radius: 8px; font-size: 14px; font-family: inherit; width: 100%; transition: border-color 0.2s; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--red); }
  textarea { resize: vertical; min-height: 70px; }

  .btn { padding: 12px 18px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; font-family: inherit; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; font-weight: bold; min-height: 44px; touch-action: manipulation; }
  .btn-red { background: linear-gradient(135deg, var(--red-light), var(--red-dark)); color: #fff; }
  .btn-outline { background: none; border: 1px solid var(--red); color: var(--red-light); }
  .btn-dark { background: var(--black4); border: 1px solid var(--border); color: var(--text); }
  .btn-success { background: var(--success); color: #fff; }
  .btn-info { background: var(--info); color: #fff; }
  .btn-whatsapp { background: #25D366; color: #fff; }
  .btn-danger { background: var(--red-dark); color: #fff; }
  .btn-sm { padding: 7px 13px; font-size: 11px; }
  .btn-row { display: flex; gap: 9px; flex-wrap: wrap; margin-top: 16px; }

  .toggle-group { display: flex; flex-wrap: wrap; gap: 7px; }
  .toggle-opt { padding: 7px 14px; border-radius: 18px; border: 1px solid var(--border); cursor: pointer; font-size: 13px; transition: all 0.2s; color: var(--text-muted); background: var(--black3); user-select: none; }
  .toggle-opt.selected { border-color: var(--red); color: var(--red-light); background: rgba(192,57,43,0.12); }

  .swatch-grid { display: grid; grid-template-columns: repeat(auto-fill, 70px); gap: 8px; }
  .swatch { width: 70px; border-radius: 8px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; overflow: hidden; }
  .swatch.selected { border-color: var(--red-light); transform: scale(1.08); }
  .swatch-colour { height: 44px; }
  .swatch-name { font-size: 7px; color: var(--text-muted); text-align: center; padding: 3px 2px; background: var(--black3); line-height: 1.3; }
  .swatch.selected .swatch-name { color: var(--red-light); }

  .stepper { display: flex; align-items: center; margin-bottom: 20px; overflow-x: auto; padding: 10px 14px; background: var(--black2); border-radius: var(--radius); border: 1px solid var(--border); gap: 4px; }
  .step { display: flex; align-items: center; gap: 6px; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); padding: 4px 6px; white-space: nowrap; }
  .step.active { color: var(--red-light); }
  .step.done { color: var(--success); }
  .step-num { width: 22px; height: 22px; border-radius: 50%; background: var(--black4); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
  .step.active .step-num { background: var(--red); color: #fff; border-color: var(--red); font-weight: bold; }
  .step.done .step-num { background: var(--success); color: #fff; border-color: var(--success); }
  .step-arrow { color: var(--border); }

  .quote-section { display: none; } .quote-section.active { display: block; }

  /* Item card â€” professional redesign */
  .item-card { background: var(--black2); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
  .item-card-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px 12px; background: linear-gradient(135deg, #1a0606 0%, var(--black2) 100%); border-bottom: 1px solid var(--border); }
  .item-card-title { color: var(--red-light); font-size: 14px; letter-spacing: 1px; text-transform: uppercase; font-weight: bold; }
  .item-card-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
  .item-tabs { display: flex; gap: 0; background: var(--black3); border-bottom: 1px solid var(--border); overflow-x: auto; }
  .item-tab { padding: 11px 18px; font-size: 12px; font-weight: bold; cursor: pointer; color: var(--text-muted); border-bottom: 3px solid transparent; font-family: inherit; background: none; border-top: none; border-left: none; border-right: none; white-space: nowrap; transition: all 0.2s; letter-spacing: 0.5px; }
  .item-tab.active { color: #fff; border-bottom-color: var(--red); background: rgba(192,57,43,0.08); }
  .item-tab-body { padding: 18px; }
  /* Section headers inside tabs */
  .tab-section { margin-bottom: 20px; }
  .tab-section-title { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--red-light); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid rgba(192,57,43,0.2); }
  /* Designer CTA */
  .designer-cta { background: linear-gradient(135deg, #1a0404, #2a0808); border: 1px solid var(--red-dark); border-radius: 10px; padding: 16px; display: flex; gap: 14px; align-items: center; margin-bottom: 18px; }
  .designer-cta-icon { font-size: 32px; flex-shrink: 0; }
  .designer-cta-text h3 { font-size: 13px; color: var(--red-light); font-weight: bold; letter-spacing: 1px; margin-bottom: 3px; }
  .designer-cta-text p { font-size: 11px; color: var(--text-muted); line-height: 1.5; }
  .designer-cta-btn { margin-left: auto; flex-shrink: 0; }
  /* Sketch thumbnail */
  .sketch-thumb-box { background: var(--black4); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .sketch-thumb-box img { width: 100%; display: block; }
  .sketch-thumb-empty { height: 70px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 12px; }
  /* Dim display from sketch */
  .dim-display { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
  .dim-pill { background: rgba(192,57,43,0.1); border: 1px solid rgba(192,57,43,0.3); border-radius: 20px; padding: 4px 12px; font-size: 12px; color: var(--red-light); font-weight: bold; }
  .dim-pill.empty { background: var(--black4); border-color: var(--border); color: var(--text-muted); }

  .price-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
  .price-row:last-child { border-bottom: none; }
  .price-label { color: var(--text-muted); }
  .price-total { font-size: 20px; color: var(--red-light); font-weight: bold; }

  .grand-bar { background: linear-gradient(135deg, var(--red-dark), #0d0d0d); border-radius: 10px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }

  .deposit-box { border-radius: 10px; padding: 14px 16px; }
  .dep-rec { background: rgba(201,168,76,0.07); border: 1px solid rgba(201,168,76,0.3); }
  .dep-act { background: rgba(39,174,96,0.07); border: 1px solid rgba(39,174,96,0.35); }
  .deposit-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
  .deposit-note { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-style: italic; }

  .internal-box { background: rgba(243,156,18,0.07); border: 1px solid rgba(243,156,18,0.3); border-radius: 8px; padding: 12px 14px; margin-bottom: 14px; font-size: 12px; color: #f5b041; }

  .sig-canvas { background: #fff; border-radius: 8px; border: 2px dashed #555; display: block; width: 100%; touch-action: none; cursor: crosshair; }


  /* â”€â”€ PRINT STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    body > *:not(#print-frame) { display: none !important; }
    #print-frame { display: block !important; position: fixed; inset: 0; background: #fff; z-index: 9999; padding: 0; }
    #print-frame .no-print { display: none !important; }
    .qp { max-width: 100%; font-size: 11px; }
    .qp-header { padding: 12px 0; }
    .qp-item-box { page-break-inside: avoid; }
    @page { size: A4; margin: 15mm 12mm; }
  }
  #print-frame { display: none; position: fixed; inset: 0; background: #fff; z-index: 9999; overflow-y: auto; padding: 20px; }
  #print-frame-inner { max-width: 700px; margin: 0 auto; }
  .print-toolbar { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #eee; }

  /* â”€â”€ SKETCH DESIGNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  .sketch-overlay { position: fixed; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important; z-index: 9999; background: #1a1a1a; display: none; flex-direction: column; box-sizing: border-box; }
  .sketch-overlay.open { display: flex; }
  .sketch-overlay-header { background: #0d0d0d; border-bottom: 2px solid var(--red-dark); padding: 0 16px; height: 56px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .sketch-overlay-title { font-size: 13px; letter-spacing: 2px; text-transform: uppercase; color: var(--red-light); font-weight: bold; }
  .sketch-item-selector { display: flex; gap: 6px; align-items: center; overflow-x: auto; max-width: 60vw; }
  .sketch-item-btn { padding: 5px 12px; border-radius: 16px; border: 1px solid var(--border); background: var(--black3); color: var(--text-muted); font-size: 11px; cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; }
  .sketch-item-btn.active { border-color: var(--red); color: var(--red-light); background: rgba(192,57,43,0.12); }

  .sketch-overlay-body { display: flex; flex: 1 1 0; overflow: hidden; min-height: 0; width: 100%; box-sizing: border-box; }
  .sketch-sidebar { width: 180px; min-width: 180px; max-width: 180px; background: #111; border-right: 1px solid var(--border); padding: 12px 10px; overflow-y: auto; flex-shrink: 0; }
  .sketch-sidebar-section { margin-bottom: 16px; }
  .sketch-sidebar-title { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
  .sketch-tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  .sk-tool { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 7px 4px; border-radius: 8px; border: 1px solid var(--border); background: var(--black3); color: var(--text-muted); cursor: pointer; font-family: inherit; font-size: 16px; transition: all 0.2s; }
  .sk-tool span { font-size: 8px; letter-spacing: 0.5px; text-transform: uppercase; }
  .sk-tool.active { border-color: var(--red); color: var(--red-light); background: rgba(192,57,43,0.12); }
  .sk-tool:hover { border-color: var(--red-dark); color: var(--text); }
  .sk-presets { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  .sk-preset { padding: 6px 4px; border-radius: 7px; border: 1px solid var(--border); background: var(--black3); color: var(--text-muted); cursor: pointer; font-size: 9px; text-align: center; font-family: inherit; transition: all 0.2s; line-height: 1.3; }
  .sk-preset:hover { border-color: var(--red-dark); color: var(--text); }
  .colour-swatch-row { display: flex; flex-wrap: wrap; gap: 5px; }
  .sk-colour { width: 24px; height: 24px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.15s; }
  .sk-colour.active { border-color: #fff; transform: scale(1.2); }
  .sk-size-row { display: flex; gap: 5px; align-items: center; }
  .sk-size { padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--black3); color: var(--text-muted); cursor: pointer; font-family: inherit; font-size: 11px; transition: all 0.2s; }
  .sk-size.active { border-color: var(--red); color: var(--red-light); }
  .sk-label-row { display: flex; flex-direction: column; gap: 5px; }

  .sketch-canvas-area { flex: 1 1 0; min-width: 0; min-height: 0; display: flex; align-items: center; justify-content: center; background: #1e1e1e; padding: 12px; overflow: hidden; }
  .sketch-canvas-wrap { background: #fff; border-radius: 4px; box-shadow: 0 8px 40px rgba(0,0,0,0.8); position: relative; }
  #sk-main-canvas { display: block; cursor: crosshair; touch-action: none; }

  .sketch-bottom-bar { height: 48px; background: #0d0d0d; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; overflow: hidden; }
  .sketch-close-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 6px 14px; border-radius: 7px; cursor: pointer; font-family: inherit; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; }
  .sketch-save-btn { background: linear-gradient(135deg, var(--red-light), var(--red-dark)); color: #fff; border: none; padding: 8px 20px; border-radius: 7px; cursor: pointer; font-family: inherit; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; font-weight: bold; white-space: nowrap; }
  .sketch-status { font-size: 11px; color: var(--text-muted); }

  .orders-grid { display: flex; flex-direction: column; gap: 12px; }
  .order-card { background: var(--black2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 18px; cursor: pointer; transition: border-color 0.2s; }
  .order-card:hover { border-color: var(--red-dark); }
  .order-id { font-size: 11px; color: var(--red-light); letter-spacing: 1px; }
  .order-name { font-size: 16px; margin: 3px 0; }
  .order-detail { font-size: 12px; color: var(--text-muted); }
  .status-badge { padding: 4px 11px; border-radius: 18px; font-size: 10px; text-transform: uppercase; font-weight: bold; white-space: nowrap; }
  .s-quoted { background: rgba(142,68,173,0.2); color: #c39bd3; border: 1px solid rgba(142,68,173,0.4); }
  .s-deposit { background: rgba(41,128,185,0.2); color: #5dade2; border: 1px solid rgba(41,128,185,0.4); }
  .s-manufacture { background: rgba(243,156,18,0.2); color: #f5b041; border: 1px solid rgba(243,156,18,0.4); }
  .s-delivery { background: rgba(142,68,173,0.2); color: #c39bd3; border: 1px solid rgba(142,68,173,0.4); }
  .s-installed { background: rgba(39,174,96,0.2); color: #58d68d; border: 1px solid rgba(39,174,96,0.4); }
  .s-complete { background: rgba(192,57,43,0.2); color: var(--red-light); border: 1px solid rgba(192,57,43,0.4); }

  .pipeline { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
  .pipe-col { min-width: 180px; background: var(--black3); border-radius: 10px; padding: 12px; flex-shrink: 0; }
  .pipe-col-title { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
  .pipe-card { background: var(--black2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 7px; font-size: 12px; cursor: pointer; }
  .pipe-card:hover { border-color: var(--red-dark); }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: center; justify-content: center; padding: 14px; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--black2); border: 1px solid var(--red-dark); border-radius: var(--radius); max-width: 760px; width: 100%; max-height: 92vh; overflow-y: auto; }
  .modal-header { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal-body { padding: 22px; }
  .modal-footer { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 9px; justify-content: flex-end; }
  .close-btn { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }

  .tc-box { background: var(--black3); border: 1px solid var(--border); border-radius: 8px; padding: 14px; font-size: 12px; color: var(--text-muted); max-height: 200px; overflow-y: auto; line-height: 1.7; }
  .tc-accept { display: flex; align-items: flex-start; gap: 9px; margin-top: 12px; }
  .tc-accept input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--red); margin-top: 2px; flex-shrink: 0; }

  /* QUOTE PREVIEW (white paper) */
  .qp { background: #fff; color: #111; border-radius: var(--radius); padding: 28px; font-family: Arial, sans-serif; }
  .qp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 3px solid #c0392b; }
  .qp-logo { font-size: 20px; font-weight: bold; color: #c0392b; letter-spacing: 2px; }
  .qp-section { margin-bottom: 16px; }
  .qp-section h3 { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #c0392b; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #f5b7b1; }
  .qp-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 12px; border-bottom: 1px solid #f5f5f5; }
  .qp-item-box { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 14px; margin-bottom: 14px; }
  .qp-item-title { font-size: 12px; font-weight: bold; color: #c0392b; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
  .qp-sig-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px; }
  .qp-sig-box { border-top: 1px solid #333; padding-top: 6px; font-size: 10px; color: #555; margin-top: 6px; }
  .qp-tc { font-size: 9px; color: #777; margin-top: 14px; padding-top: 10px; border-top: 1px solid #eee; line-height: 1.6; }

  .divider { height: 1px; background: var(--border); margin: 14px 0; }
  .muted { color: var(--text-muted); font-size: 13px; }
  .counter { display: flex; align-items: center; gap: 9px; }
  .counter button { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--black3); color: var(--text); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .counter span { font-size: 17px; min-width: 26px; text-align: center; }

  #toast { position: fixed; bottom: 20px; right: 20px; background: var(--black2); border: 1px solid var(--red); border-radius: 10px; padding: 12px 18px; font-size: 13px; z-index: 999; display: none; max-width: 300px; }

  @media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-grid-3 { grid-template-columns: 1fr 1fr; }
    .nav-btn { padding: 8px 8px; font-size: 10px; }
    .qp-sig-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸ </div>
    <div>
      <div class="logo-text">Luxury House</div>
      <div class="logo-sub">Quote &amp; Order Management</div>
    </div>
  </div>
  <nav>
    <button class="nav-btn active" onclick="showPage('quote')" id="tab-quote">âœï¸ New Quote</button>
    <button class="nav-btn" onclick="showPage('orders')" id="tab-orders">ğŸ“‹ Orders</button>
    <button class="nav-btn" onclick="showPage('pipeline')" id="tab-pipeline">ğŸ“Š Pipeline</button>
  </nav>
</header>

<main>

<!-- PAGE: QUOTE -->
<div class="page active" id="page-quote">
  <div class="stepper">
    <div class="step active" id="si-1"><span class="step-num">1</span> Customer</div>
    <div class="step-arrow">â€º</div>
    <div class="step" id="si-2"><span class="step-num">2</span> Items</div>
    <div class="step-arrow">â€º</div>
    <div class="step" id="si-3"><span class="step-num">3</span> Deposit &amp; Sign</div>
    <div class="step-arrow">â€º</div>
    <div class="step" id="si-4"><span class="step-num">4</span> Send</div>
  </div>

  <!-- STEP 1 -->
  <div class="quote-section active" id="qs-1">
    <div class="card">
      <div class="card-title">ğŸ‘¤ Customer Details</div>
      <!-- Required fields â€” large and clear -->
      <div style="margin-bottom:18px">
        <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--red-light);margin-bottom:12px;border-bottom:1px solid rgba(192,57,43,0.2);padding-bottom:6px">Required Details</div>
        <div class="form-grid">
          <div class="form-group">
            <label>First Name <span style="color:var(--red-light)">*</span></label>
            <input type="text" id="c-first" placeholder="James" style="font-size:16px">
          </div>
          <div class="form-group">
            <label>Phone / WhatsApp <span style="color:var(--red-light)">*</span></label>
            <input type="tel" id="c-phone" placeholder="+44 7700 900000" style="font-size:16px">
          </div>
          <div class="form-group full">
            <label>Installation Address <span style="color:var(--red-light)">*</span></label>
            <input type="text" id="c-address" placeholder="12 Manor Road, London, SW1A 1AA" style="font-size:16px">
          </div>
        </div>
      </div>

      <!-- Optional fields â€” smaller, collapsed feel -->
      <div style="margin-bottom:18px">
        <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:6px">Additional Details (optional)</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="c-last" placeholder="Mitchell">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="c-email" placeholder="james@email.com">
          </div>
          <div class="form-group">
            <label>Lead Source</label>
            <select id="c-source">
              <option>Website Enquiry</option><option>Referral</option><option>Social Media</option>
              <option>Showroom Visit</option><option>Google Ads</option><option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Agent / Salesman</label>
            <input type="text" id="c-surveyor" placeholder="Your name">
          </div>
          <div class="form-group full">
            <label>ğŸ”’ Internal Notes</label>
            <textarea id="c-notes" rows="2" placeholder="Deposit agreed, customer preferences, follow-up actions..."></textarea>
          </div>
        </div>
      </div>

      <div class="btn-row"><button class="btn btn-red" onclick="goStep(2)" style="font-size:14px;padding:14px 28px">Next: Add Items â†’</button></div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="quote-section" id="qs-2">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px">
      <div>
        <div style="font-size:18px;font-weight:bold;color:var(--red-light);letter-spacing:1px">Wardrobe Items</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:3px">One card per wardrobe or room â€” design, finish, interior and price all in one place</div>
      </div>
      <button class="btn btn-outline" onclick="addItem()" style="white-space:nowrap;flex-shrink:0">+ Add Room</button>
    </div>
    <div id="items-container"></div>
    <div class="btn-row" style="margin-top:20px">
      <button class="btn btn-dark btn-sm" onclick="goStep(1)">â† Back</button>
      <button class="btn btn-red" onclick="goStep(3)" style="font-size:14px;padding:14px 28px">Next: Deposit &amp; Sign â†’</button>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="quote-section" id="qs-3">
    <div class="internal-box"><strong style="font-size:10px;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:4px">ğŸ”’ Internal â€” not shown on customer quote</strong>Deposit details and agent notes are for your records only.</div>
    <div id="grand-total-display"></div>
    <div class="card">
      <div class="card-title">ğŸ’³ Deposit & Payment</div>
      <div style="margin-bottom:16px">
        <div class="deposit-box dep-act" style="max-width:360px">
          <div class="deposit-label">Deposit Taken Today</div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:6px">
            <span style="font-size:20px;color:#58d68d">Â£</span>
            <input type="number" id="deposit-actual" placeholder="e.g. 500"
              style="font-size:22px;font-weight:bold;color:#58d68d;background:transparent;border:none;border-bottom:2px solid #27ae60;border-radius:0;padding:4px 0;width:130px"
              oninput="updateGrandTotal()">
          </div>
          <div class="deposit-note">Enter the agreed deposit amount</div>
        </div>
      </div>
      <div id="balance-breakdown"></div>
      <div class="form-grid" style="margin-top:16px">
        <div class="form-group"><label>Payment Method</label>
          <select id="payment-method"><option>Bank Transfer</option><option>Card (in person)</option><option>Card (payment link)</option><option>Cash</option><option>Cheque</option></select>
        </div>
        <div class="form-group"><label>Expected Install Date</label><input type="date" id="install-date"></div>
        <div class="form-group"><label>Lead Time</label>
          <select id="lead-time"><option>6â€“8 Weeks</option><option>8â€“10 Weeks</option><option>10â€“12 Weeks</option><option>12â€“14 Weeks</option><option>Custom (see notes)</option></select>
        </div>
        <div class="form-group"><label>Discount (Â£)</label><input type="number" id="discount-amt" placeholder="0" oninput="updateGrandTotal()"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“„ Terms &amp; Conditions</div>
      <div class="tc-box">
        <strong>Bespoke Furniture Terms &amp; Conditions â€” Luxury House Online / Luxury Fitted Wardrobes</strong><br><br>
        <strong>1. Bespoke Orders.</strong> All furniture is manufactured to the customer's exact specifications. Orders are non-cancellable and non-refundable once manufacturing commences. Any deposit paid is strictly non-refundable.<br><br>
        <strong>2. Deposit &amp; Payment.</strong> A deposit is required to confirm the order. The balance is due in full on the day of installation prior to fitting. The company reserves the right to withhold installation until full payment is received.<br><br>
        <strong>3. Survey &amp; Dimensions.</strong> Dimensions are taken at survey. The customer must ensure the space is clear and accessible on the agreed installation date.<br><br>
        <strong>4. Lead Times.</strong> Estimated lead times are provided in good faith and are not contractually binding. Standard lead time is 6â€“14 weeks from deposit receipt.<br><br>
        <strong>5. Colours &amp; Finishes.</strong> Egger and Kronospan board samples are representative. Minor colour or grain variations within industry tolerances are not defects.<br><br>
        <strong>6. Warranty.</strong> 2-year workmanship warranty. 5-year structural warranty under normal domestic use. Does not cover misuse, moisture, heat, or third-party modifications.<br><br>
        <strong>7. Installation.</strong> Customer must provide clear access. Includes fitting and packaging waste removal. Company not responsible for redecoration after installation.<br><br>
        <strong>8. Overdue Balances.</strong> Outstanding balances incur interest at 8% per annum after 14 days. The company reserves the right to recover goods in cases of non-payment.<br><br>
        <strong>9. Governing Law.</strong> These terms are governed by the laws of England and Wales.<br><br>
        <strong>10. Quote Validity.</strong> This quote is valid for 30 days from the date of issue.
      </div>
      <div class="tc-accept">
        <input type="checkbox" id="tc-checkbox">
        <label for="tc-checkbox" style="text-transform:none;letter-spacing:0;font-size:13px;color:var(--text)">I confirm the customer has been presented with and agrees to these Terms &amp; Conditions.</label>
      </div>
    </div>

    <div class="card">
      <div class="card-title">âœï¸ Signatures</div>
      <div class="form-grid">
        <div>
          <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Customer Signature</div>
          <canvas id="sig-customer" class="sig-canvas" height="120"></canvas>
          <button class="btn btn-dark btn-sm" style="margin-top:6px" onclick="clearSig('sig-customer')">Clear</button>
          <div class="form-grid" style="margin-top:10px;grid-template-columns:1fr 1fr;gap:10px">
            <div class="form-group"><label>Customer Printed Name</label><input type="text" id="sig-customer-name" placeholder="Full name"></div>
            <div class="form-group"><label>Date Signed</label><input type="date" id="sig-customer-date"></div>
          </div>
        </div>
        <div>
          <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Agent Signature</div>
          <canvas id="sig-agent" class="sig-canvas" height="120"></canvas>
          <button class="btn btn-dark btn-sm" style="margin-top:6px" onclick="clearSig('sig-agent')">Clear</button>
          <div class="form-group" style="margin-top:10px"><label>Agent Printed Name</label><input type="text" id="sig-agent-name" placeholder="Full name"></div>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-dark btn-sm" onclick="goStep(2)">â† Back</button>
      <button class="btn btn-red" onclick="goStep(4)">Next: Preview &amp; Send â†’</button>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="quote-section" id="qs-4">
    <div class="card">
      <div class="card-title">ğŸ“¤ Preview &amp; Send</div>
      <div class="btn-row">
        <button class="btn btn-red" onclick="openQuotePreview()">ğŸ‘ï¸ Preview Quote</button>
        <button class="btn btn-info" onclick="sendEmail()">ğŸ“§ Email Customer</button>
        <button class="btn btn-whatsapp" onclick="sendWhatsapp()">ğŸ’¬ WhatsApp</button>
        <button class="btn btn-success" onclick="saveOrder()">âœ… Save &amp; Track Order</button>
      </div>
      <p class="muted" style="margin-top:12px;font-size:12px">Once saved, the order appears in Orders and Pipeline for your whole team.</p>
    </div>
    <div id="final-preview" style="margin-top:16px"></div>
    <div class="btn-row"><button class="btn btn-dark btn-sm" onclick="goStep(3)">â† Back</button></div>
  </div>
</div>

<!-- PAGE: ORDERS -->
<div class="page" id="page-orders">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
    <h2 style="font-size:18px;color:var(--red-light);letter-spacing:2px;text-transform:uppercase">All Orders</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="status-filter" onchange="renderOrders()" style="width:auto;font-size:12px;padding:7px 10px">
        <option value="">All Statuses</option>
        <option value="Quoted">Quoted</option>
        <option value="Deposit Taken">Deposit Taken</option>
        <option value="In Manufacture">In Manufacture</option>
        <option value="Delivery Scheduled">Delivery Scheduled</option>
        <option value="Installed">Installed</option>
        <option value="Complete">Complete</option>
      </select>
      <button class="btn btn-red btn-sm" onclick="showPage('quote')">+ New Quote</button>
    </div>
  </div>
  <div class="orders-grid" id="orders-list"><div class="muted" style="text-align:center;padding:40px">No orders yet.</div></div>
</div>

<!-- PAGE: PIPELINE -->
<div class="page" id="page-pipeline">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
    <h2 style="font-size:18px;color:var(--red-light);letter-spacing:2px;text-transform:uppercase">Pipeline</h2>
    <div id="pipeline-summary" class="muted"></div>
  </div>
  <div class="pipeline" id="pipeline-board"></div>
</div>

</main>

<!-- FLOATING SKETCH BUTTON -->

<!-- FULL SCREEN SKETCH DESIGNER -->
<div class="sketch-overlay" id="sketch-overlay">
  <div class="sketch-overlay-header">
    <div style="display:flex;align-items:center;gap:14px">
      <div class="sketch-overlay-title">âœï¸ Wardrobe Designer</div>
      <div class="sketch-item-selector" id="sk-item-selector"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="sketch-status" id="sk-status">Front view â€¢ Scale drawing</span>
      <button class="sketch-close-btn" onclick="closeSketchDesigner()">âœ• Close</button>
    </div>
  </div>

  <div class="sketch-overlay-body">
    <!-- SIDEBAR: Tools -->
    <div class="sketch-sidebar">

      <div class="sketch-sidebar-section">
        <div class="sketch-sidebar-title">Drawing Tools</div>
        <div class="sketch-tool-grid">
          <button class="sk-tool active" id="sktool-select" onclick="skSetTool('select')">â†–<span>Select</span></button>
          <button class="sk-tool" id="sktool-wall" onclick="skSetTool('wall')">â–­<span>Wall Unit</span></button>
          <button class="sk-tool" id="sktool-corner" onclick="skSetTool('corner')">âŒ<span>Corner</span></button>
          <button class="sk-tool" id="sktool-triangle" onclick="skSetTool('triangle')">â–³<span>Angled</span></button>
          <button class="sk-tool" id="sktool-door" onclick="skSetTool('door-l')" title="Left-hand door">ğŸšª<span>Door L</span></button>
          <button class="sk-tool" id="sktool-door-r" onclick="skSetTool('door-r')" title="Right-hand door">ğŸšª<span>Door R</span></button>
          <button class="sk-tool" id="sktool-shelf" onclick="skSetTool('shelf')">â–¬<span>Shelf</span></button>
          <button class="sk-tool" id="sktool-hanging" onclick="skSetTool('hanging')">ã€°<span>Rail</span></button>
          <button class="sk-tool" id="sktool-drawer" onclick="skSetTool('drawer')">â–¤<span>Drawer</span></button>
          <button class="sk-tool" id="sktool-text" onclick="skSetTool('text')">T<span>Label</span></button>
          <button class="sk-tool" id="sktool-pen" onclick="skSetTool('pen')" style="grid-column:1/-1">âœï¸<span>Freehand</span></button>
        </div>
      </div>

      <div class="sketch-sidebar-section">
        <div class="sketch-sidebar-title">Quick Insert â€” Presets</div>
        <div class="sk-presets">
          <button class="sk-preset" onclick="skInsertPreset('single-wardrobe')">Single<br>Wardrobe</button>
          <button class="sk-preset" onclick="skInsertPreset('double-wardrobe')">Double<br>Wardrobe</button>
          <button class="sk-preset" onclick="skInsertPreset('triple-wardrobe')">Triple<br>Wardrobe</button>
          <button class="sk-preset" onclick="skInsertPreset('corner-unit')">Corner<br>Unit</button>
          <button class="sk-preset" onclick="skInsertPreset('tall-shelf')">Shelf<br>Tower</button>
          <button class="sk-preset" onclick="skInsertPreset('single-drawer')">Single<br>Drawer</button>
          <button class="sk-preset" onclick="skInsertPreset('dressing-desk')">Desk &amp;<br>Mirror</button>
          <button class="sk-preset" onclick="skInsertPreset('top-box')">Top<br>Box</button>
        </div>
      </div>

      <div class="sketch-sidebar-section">
        <div class="sketch-sidebar-title">Colour</div>
        <div class="colour-swatch-row">
          <div class="sk-colour active" style="background:#1a1a1a" onclick="skSetColour('#1a1a1a',this)" title="Black"></div>
          <div class="sk-colour" style="background:#c0392b" onclick="skSetColour('#c0392b',this)" title="Red"></div>
          <div class="sk-colour" style="background:#2c3e50" onclick="skSetColour('#2c3e50',this)" title="Navy"></div>
          <div class="sk-colour" style="background:#7f8c8d" onclick="skSetColour('#7f8c8d',this)" title="Grey"></div>
          <div class="sk-colour" style="background:#d4b896" onclick="skSetColour('#d4b896',this)" title="Oak"></div>
          <div class="sk-colour" style="background:#5c3d1e" onclick="skSetColour('#5c3d1e',this)" title="Walnut"></div>
          <div class="sk-colour" style="background:#f8f8f8;border:1px solid #ccc" onclick="skSetColour('#f8f8f8',this)" title="White"></div>
          <div class="sk-colour" style="background:#c9a84c" onclick="skSetColour('#c9a84c',this)" title="Gold"></div>
        </div>
      </div>

      <div class="sketch-sidebar-section">
        <div class="sketch-sidebar-title">Stroke Weight</div>
        <div class="sk-size-row">
          <button class="sk-size" id="sksize-1" onclick="skSetSize(1)">Fine</button>
          <button class="sk-size active" id="sksize-2" onclick="skSetSize(2)">Med</button>
          <button class="sk-size" id="sksize-3" onclick="skSetSize(3)">Bold</button>
        </div>
      </div>

      <div class="sketch-sidebar-section">
        <div class="sketch-sidebar-title">Label Text</div>
        <div class="sk-label-row">
          <input type="text" id="sk-label-input" placeholder="e.g. Rail, Shoe shelf..." style="font-size:12px">
          <button class="sk-preset" style="grid-column:1/-1;padding:7px" onclick="skSetTool('text')">â†’ Click canvas to place</button>
        </div>
      </div>

      <div class="sketch-sidebar-section">
        <div class="sketch-sidebar-title">History</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px">
          <button class="sk-preset" onclick="skUndo()">â†© Undo</button>
          <button class="sk-preset" onclick="skClear()">ğŸ—‘ Clear</button>
          <button class="sk-preset" id="sk-delete-btn" onclick="skDeleteSelected()"
            style="grid-column:1/-1;background:rgba(192,57,43,0.25);border-color:var(--red-dark);color:#e74c3c;display:none">
            ğŸ—‘ Delete Selected
          </button>
        </div>
        <div style="margin-top:6px">
          <div class="sketch-sidebar-title" style="margin-bottom:5px">Group Select</div>
          <div style="font-size:9px;color:var(--text-muted);line-height:1.5;margin-bottom:5px">
            Draw a lasso rect over shapes, then drag to move group
          </div>
          <button class="sk-tool${skState&&skState.tool==='lasso'?' active':''}" id="sktool-lasso"
            onclick="skSetTool('lasso')" style="width:100%;flex-direction:row;justify-content:center;gap:6px;padding:7px">
            â¬š<span>Lasso Move</span>
          </button>
          <button class="sk-preset" onclick="skSelectAll()" style="width:100%;margin-top:5px">Select All â†’ Move</button>
        </div>
      </div>

    </div>

    <div class="sketch-canvas-area">
      <div class="sketch-canvas-wrap">
        <canvas id="sk-main-canvas"></canvas>
      </div>
    </div>

  </div><!-- end sketch-overlay-body -->

  <div class="sketch-bottom-bar">
    <div style="display:flex;gap:10px;font-size:11px;color:var(--text-muted);flex-wrap:wrap">
      <span>ğŸ’¡ <strong style="color:var(--text)">Drag</strong> to draw shapes</span>
      <span>Â· <strong style="color:var(--text)">Select</strong> then drag to move Â· drag handle to resize</span>
      <span>Â· <strong style="color:var(--text)">Delete / âŒ«</strong> removes selected</span>
      <span>Â· <strong style="color:var(--text)">Double-click</strong> any label/size to edit value</span>
    </div>
    <div style="display:flex;gap:8px">
      <button class="sketch-save-btn" style="background:#333;border:1px solid #555" onclick="skPrintFactory()">ğŸ–¨ï¸ Print Factory Sheet</button>
      <button class="sketch-save-btn" onclick="skSaveToItem()">ğŸ’¾ Save Design to Quote</button>
    </div>
  </div>
</div>

<!-- QUOTE PREVIEW MODAL -->
<div class="modal-overlay" id="modal-preview">
  <div class="modal" style="max-width:860px">
    <div class="modal-header">
      <span style="color:var(--red-light);font-size:12px;letter-spacing:2px;text-transform:uppercase">Customer Quote Preview</span>
      <button class="close-btn" onclick="closeModal('modal-preview')">Ã—</button>
    </div>
    <div class="modal-body"><div id="quote-preview-content"></div></div>
    <div class="modal-footer">
      <button class="btn btn-info btn-sm" onclick="sendEmail()">ğŸ“§ Email</button>
      <button class="btn btn-whatsapp btn-sm" onclick="sendWhatsapp()">ğŸ’¬ WhatsApp</button>
      <button class="btn btn-dark btn-sm" onclick="closeModal('modal-preview')">Close</button>
    </div>
  </div>
</div>

<!-- ORDER DETAIL MODAL -->
<div class="modal-overlay" id="modal-order">
  <div class="modal">
    <div class="modal-header">
      <span id="modal-order-title" style="color:var(--red-light);font-size:12px;letter-spacing:2px;text-transform:uppercase">Order Detail</span>
      <button class="close-btn" onclick="closeModal('modal-order')">Ã—</button>
    </div>
    <div class="modal-body" id="modal-order-body"></div>
    <div class="modal-footer"><button class="btn btn-dark btn-sm" onclick="closeModal('modal-order')">Close</button></div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RATE_SLIDING = 1100;  // Â£ per metre WIDTH
const RATE_HINGED = 950;    // Â£ per metre WIDTH
const RATE_NON = 950;       // alias
const SLIDING_TYPES = ['Sliding Door Fitted','Sliding Door Walk-In'];
const HINGED_TYPES  = ['Hinged Door Fitted','Walk-In Wardrobe','Alcove Wardrobe','Corner Wardrobe'];

let orders = JSON.parse(localStorage.getItem('lh_v3_orders') || '[]');
let currentStep = 1;
let items = [];
let itemCounter = 0;

const boardColours = [
  {code:'W1000',name:'Alpine White',brand:'Egger',hex:'#f8f8f8'},
  {code:'W1100',name:'Cream',brand:'Egger',hex:'#f5f0e0'},
  {code:'W980',name:'Pure White',brand:'Kronospan',hex:'#fefefe'},
  {code:'U374',name:'Magnolia',brand:'Egger',hex:'#f0ead6'},
  {code:'U708',name:'Light Grey',brand:'Egger',hex:'#c8c8c8'},
  {code:'U732',name:'Dust Grey',brand:'Egger',hex:'#a8a8a0'},
  {code:'U741',name:'Pebble Grey',brand:'Egger',hex:'#909090'},
  {code:'U960',name:'Anthracite',brand:'Egger',hex:'#3c3c3c'},
  {code:'U999',name:'Black',brand:'Egger',hex:'#111111'},
  {code:'U560',name:'Steel Blue',brand:'Egger',hex:'#4a6fa5'},
  {code:'U104',name:'Navy Blue',brand:'Egger',hex:'#1a2a4a'},
  {code:'U612',name:'Sage Green',brand:'Egger',hex:'#7a9e7e'},
  {code:'U130',name:'Forest Green',brand:'Egger',hex:'#2d5016'},
  {code:'U444',name:'Sand Beige',brand:'Egger',hex:'#d4b896'},
  {code:'U702',name:'Stone',brand:'Egger',hex:'#c0b09a'},
  {code:'H1180',name:'Natural Oak',brand:'Egger',hex:'#c8a87a'},
  {code:'H3431',name:'Light Walnut',brand:'Egger',hex:'#9c7a5a'},
  {code:'H3734',name:'Dark Walnut',brand:'Egger',hex:'#5c3d1e'},
  {code:'H1486',name:'Smoked Oak',brand:'Egger',hex:'#7a6248'},
  {code:'K017',name:'Davos Oak',brand:'Kronospan',hex:'#b8966a'},
  {code:'K002',name:'White Loft Oak',brand:'Kronospan',hex:'#ddd0b8'},
  {code:'U636',name:'Dusty Rose',brand:'Egger',hex:'#d4a0a0'},
  {code:'U140',name:'Mint',brand:'Egger',hex:'#a8d8b0'},
  {code:'K522',name:'Graphite',brand:'Kronospan',hex:'#555555'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEM MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newItem(id) {
  return {
    id, type:'Sliding Door Fitted', room:'Master Bedroom', doors:'2 Door',
    w:'', h:'', d:'', units:1,
    doorStyle:'Handleless', finish:'Matt', colour:boardColours[0], customColour:'',
    handles:'None / Handleless', rails:'Long Hang (Full Height)', shelves:4,
    drawers:0, addons:[], interiorFinish:'White', customAddon:'', layoutPreset:'',
    bespokeNotes:'', extraPrice:0, extras:[], sketchHistory:[], activeTab:'design'
  };
}

function addItem() {
  itemCounter++;
  items.push(newItem(itemCounter));
  renderItems();
}

function removeItem(id) {
  if (items.length <= 1) { toast('Need at least one item'); return; }
  if (!confirm('Remove this item?')) return;
  items = items.filter(i => i.id !== id);
  renderItems();
}

function getItem(id) { return items.find(i => i.id === id); }

function renderItems() {
  const c = document.getElementById('items-container');
  c.innerHTML = '';
  items.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'item-card';
    div.id = 'item-card-' + item.id;
    div.innerHTML = buildItemHTML(item, idx);
    c.appendChild(div);
  });
}


function buildDoorGallery(item) {
  var groups = [], seenG = {};
  DOOR_STYLE_GALLERY.forEach(function(d){ if(!seenG[d.group]){seenG[d.group]=true; groups.push(d.group);} });

  var html = '<div style="font-size:10px;color:#888;margin-bottom:8px;">Hinged door styles from Browns 2000 â€” tap any to select. Photos load when online.</div>';

  groups.forEach(function(grp) {
    html += '<div style="grid-column:1/-1;display:flex;align-items:center;gap:8px;margin:10px 0 5px;">'
          + '<span style="font-size:9px;font-weight:bold;letter-spacing:2px;text-transform:uppercase;color:#c0392b;">' + grp + '</span>'
          + '<div style="flex:1;height:1px;background:#333;"></div></div>';

    DOOR_STYLE_GALLERY.forEach(function(ds) {
      if (ds.group !== grp) return;
      var sel = item.doorStyle === ds.name;
      var safeName = ds.name.replace(/'/g, "\\'");
      var cardBorder = sel ? '2px solid #c0392b' : '2px solid #333';
      var cardGlow   = sel ? 'box-shadow:0 0 0 3px rgba(192,57,43,0.35);' : '';

      var photoArea;
      if (ds.img) {
        photoArea = '<div style="position:relative;height:100px;background:' + ds.bg + ';overflow:hidden;">'
          + '<img src="' + ds.img + '" style="width:100%;height:100%;object-fit:cover;display:block;" onerror="this.style.display=\'none\'" loading="lazy">'
          + (ds.popular ? '<div style="position:absolute;top:4px;left:4px;background:#c0392b;color:#fff;font-size:8px;font-weight:bold;letter-spacing:1px;padding:2px 6px;border-radius:3px;">&#9733; POPULAR</div>' : '')
          + (sel ? '<div style="position:absolute;bottom:4px;right:4px;background:#c0392b;color:#fff;font-size:9px;font-weight:bold;padding:2px 7px;border-radius:3px;">&#10003; Selected</div>' : '')
          + '</div>';
      } else {
        photoArea = '<div style="height:100px;background:' + ds.bg + ';display:flex;align-items:center;justify-content:center;font-size:32px;position:relative;">'
          + (ds.icon || '&#9635;')
          + (sel ? '<div style="position:absolute;bottom:4px;right:4px;background:#c0392b;color:#fff;font-size:9px;font-weight:bold;padding:2px 7px;border-radius:3px;">&#10003; Selected</div>' : '')
          + '</div>';
      }

      html += '<div onclick="setField(' + item.id + ',\'doorStyle\',\'' + safeName + '\')"'
            + ' style="' + cardBorder + ';border-radius:9px;overflow:hidden;cursor:pointer;background:#1e1e1e;transition:all 0.18s;' + cardGlow + '">'
            + photoArea
            + '<div style="padding:7px 8px;">'
            + '<div style="font-size:11px;font-weight:bold;color:' + (sel ? '#e74c3c' : '#f0f0f0') + ';line-height:1.3;">' + ds.name.split(' \u2014 ')[0] + '</div>'
            + '<div style="font-size:10px;color:#999;margin-top:2px;line-height:1.3;">' + ds.sub + '</div>'
            + '</div></div>';
    });
  });

  return html;
}

function buildItemHTML(item, idx) {
  var num = idx + 1;
  var id = item.id;
  var isSliding = SLIDING_TYPES.includes(item.type);
  var activeTab = item.activeTab || 'design';

  // â”€â”€ swatches â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var swatches = boardColours.map(function(c) {
    var sel = item.colour && item.colour.code === c.code ? ' selected' : '';
    return '<div class="swatch' + sel + '" onclick="setColour(' + id + ',\'' + c.code + '\')">' +
      '<div class="swatch-colour" style="background:' + c.hex + '"></div>' +
      '<div class="swatch-name">' + c.code + '<br>' + c.name + '</div></div>';
  }).join('');

  // â”€â”€ addons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var addons = Object.keys(EXTRA_PRICES).map(function(o) {
    var sel = item.addons.includes(o) ? ' selected' : '';
    return '<div class="toggle-opt' + sel + '" onclick="toggleAddon(' + id + ',\'' + o + '\')">' + o + '</div>';
  }).join('');

  // â”€â”€ door config toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var doorPresets = ['2 Door','3 Door','Open / No Doors'];
  var doorIsOther = item.doors && !doorPresets.includes(item.doors);
  var doorToggles = doorPresets.map(function(o) {
    return '<div class="toggle-opt' + (item.doors===o?' selected':'') + '" onclick="setField(' + id + ',\'doors\',\'' + o + '\')">' + o + '</div>';
  }).join('') + '<div class="toggle-opt' + (doorIsOther?' selected':'') + '" onclick="setFieldOther(' + id + ',\'doors\',\'__other__\',\'oth-doors-' + id + '\')">âœï¸ Other</div>';

  // â”€â”€ type toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var typeIsOther = item.type && !SLIDING_TYPES.includes(item.type) && !HINGED_TYPES.includes(item.type) && item.type !== 'Hinged Door Fitted';
  var typeToggles =
    '<div class="toggle-opt' + (SLIDING_TYPES.includes(item.type)?' selected':'') + '" onclick="setFieldAndRender(' + id + ',\'type\',\'Sliding Door Fitted\')">Sliding</div>' +
    '<div class="toggle-opt' + (item.type==='Hinged Door Fitted'?' selected':'') + '" onclick="setFieldAndRender(' + id + ',\'type\',\'Hinged Door Fitted\')">Hinged</div>' +
    '<div class="toggle-opt' + (typeIsOther?' selected':'') + '" onclick="setFieldOther(' + id + ',\'type\',\'__other__\',\'oth-type-' + id + '\')">âœï¸ Other</div>';

  // â”€â”€ room options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var rooms = ['Master Bedroom','Bedroom 2','Bedroom 3','Dressing Room','Landing / Hallway','Study / Office'];
  var roomIsOther = item.room && !rooms.includes(item.room);
  var roomOpts = rooms.map(function(r) {
    return '<option' + (item.room===r?' selected':'') + '>' + r + '</option>';
  }).join('') + '<option' + (roomIsOther?' selected':'') + '>Other</option>';

  // â”€â”€ sketch status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var hasPNG = !!item.sketchPNG;
  var designerBtnLabel = hasPNG ? 'âœï¸ Edit Design' : 'âœï¸ Open Designer';
  var sketchStatus = hasPNG
    ? '<span style="color:var(--success);font-size:11px;font-weight:bold">âœ“ Design saved</span>'
    : '<span style="font-size:11px;color:var(--text-muted)">No design yet</span>';

  // â”€â”€ handle finish label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var handleLabel = 'Handle Finish' + (isSliding ? ' <span style="font-size:9px;color:var(--text-muted)">(none for sliding)</span>' : '');
  var handleOpts = ['None / Handleless','Brushed Gold','Matt Black','Chrome','Brushed Nickel','Antique Brass'].map(function(o) {
    return '<div class="toggle-opt' + (item.handles===o?' selected':'') + '" onclick="setField(' + id + ',\'handles\',\'' + o + '\')">' + o + '</div>';
  }).join('');

  // â”€â”€ interior opts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var interiorOpts = ['Matching','White','Grey','Any'].map(function(o) {
    return '<div class="toggle-opt' + (item.interiorFinish===o?' selected':'') + '" onclick="setField(' + id + ',\'interiorFinish\',\'' + o + '\')">' + o + '</div>';
  }).join('');

  var railOpts = ['Long Hang (Full Height)','Double Hang','Half & Half','No Rails'].map(function(o) {
    return '<div class="toggle-opt' + (item.rails===o?' selected':'') + '" onclick="setField(' + id + ',\'rails\',\'' + o + '\')">' + o + '</div>';
  }).join('');

  // â”€â”€ door gallery (hinged only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var doorGalleryBlock = isSliding
    ? '<div style="background:rgba(192,57,43,0.08);border:1px solid rgba(192,57,43,0.3);border-radius:8px;padding:12px;color:var(--text-muted);font-size:12px">Sliding wardrobes are handleless â€” board colour determines the panel finish. Choose a board colour below.</div>'
    : '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:420px;overflow-y:auto;padding:2px 4px">' +
        buildDoorGallery(item) +
      '</div>' +
      '<input type="text" id="oth-style-' + id + '" placeholder="Describe custom door style..." ' +
        'style="margin-top:8px;display:' + (!DOOR_STYLE_GALLERY.map(function(d){return d.name;}).includes(item.doorStyle)&&item.doorStyle?'block':'none') + '" ' +
        'value="' + (!DOOR_STYLE_GALLERY.map(function(d){return d.name;}).includes(item.doorStyle)?item.doorStyle:'') + '" ' +
        'oninput="setField(' + id + ',\'doorStyle\',this.value)">' +
      (item.doorStyle ? '<div style="margin-top:8px;padding:8px 12px;background:rgba(192,57,43,0.1);border:1px solid rgba(192,57,43,0.3);border-radius:8px;font-size:12px;color:var(--red-light);font-weight:bold">âœ“ Selected: ' + item.doorStyle + '</div>' : '');

  // â”€â”€ finish toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var finishOpts = ['Matt','Gloss'].map(function(o) {
    return '<div class="toggle-opt' + (item.finish===o?' selected':'') + '" onclick="setField(' + id + ',\'finish\',\'' + o + '\')">' + o + '</div>';
  }).join('') + '<div class="toggle-opt' + (item.finish&&item.finish!=='Matt'&&item.finish!=='Gloss'?' selected':'') + '" onclick="document.getElementById(\'oth-finish-' + id + '\').style.display=\'block\'">âœï¸ Other</div>';

  // â”€â”€ colour status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var colourStatus = item.colour ? '<div style="margin-top:6px;font-size:11px;color:var(--red-light)">âœ“ ' + item.colour.code + ' ' + item.colour.name + ' (' + item.colour.brand + ')</div>' : '';

  // â”€â”€ remove button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var removeBtn = items.length > 1 ? '<button class="btn btn-danger btn-sm" onclick="removeItem(' + id + ')">âœ•</button>' : '';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUILD HTML â€” plain string concat, no nested backticks
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var h = '';

  // Header
  h += '<div class="item-card-header">';
  h += '<div>';
  h += '<div class="item-card-title"><span style="opacity:0.5;font-size:11px;margin-right:6px">#' + num + '</span>' + (item.room||'New Item') + '</div>';
  h += '<div class="item-card-subtitle">' + (item.type||'Type not set') + ' Â· ' + (item.doors||'Doors not set') + ' Â· ' + (item.w ? item.w + 'mm wide' : 'Width not set') + '</div>';
  h += '</div>';
  h += '<div style="display:flex;gap:8px;align-items:center">';
  h += '<span id="badge-' + id + '" style="color:var(--red-light);font-weight:bold;font-size:13px"></span>';
  h += removeBtn;
  h += '</div></div>';

  // Tabs
  var tabs = [['design','âœï¸ Design'],['finish','ğŸ¨ Finish'],['interior','ğŸªµ Interior'],['price','ğŸ’° Price']];
  h += '<div class="item-tabs">';
  tabs.forEach(function(t) {
    h += '<button class="item-tab' + (activeTab===t[0]?' active':'') + '" onclick="switchTab(' + id + ',\'' + t[0] + '\')">' + t[1] + '</button>';
  });
  h += '</div>';

  // â”€â”€ DESIGN TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  h += '<div id="tab-design-' + id + '" class="item-tab-body" style="display:' + (activeTab==='design'?'block':'none') + '">';

  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">';
  // Type
  h += '<div class="form-group"><label>Wardrobe Type</label>';
  h += '<div class="toggle-group" style="margin-top:4px">' + typeToggles + '</div>';
  h += '<input type="text" id="oth-type-' + id + '" placeholder="e.g. Walk-in, Alcove..." style="margin-top:6px;display:' + (typeIsOther?'block':'none') + '" value="' + (typeIsOther?item.type:'') + '" oninput="setFieldAndRender(' + id + ',\'type\',this.value)"></div>';
  // Room
  h += '<div class="form-group"><label>Room</label>';
  h += '<select style="margin-top:4px" onchange="setFieldAndRender(' + id + ',\'room\',this.value)">' + roomOpts + '</select>';
  h += '<input type="text" id="oth-room-' + id + '" placeholder="Enter room name..." style="margin-top:6px;display:' + (roomIsOther?'block':'none') + '" value="' + (roomIsOther?item.room:'') + '" oninput="setFieldAndRender(' + id + ',\'room\',this.value)"></div>';
  h += '</div>';

  // Door config
  h += '<div class="form-group" style="margin-bottom:18px"><label>Door Configuration</label>';
  h += '<div class="toggle-group" style="margin-top:4px">' + doorToggles + '</div>';
  h += '<input type="text" id="oth-doors-' + id + '" placeholder="e.g. 4 Door, Bifold..." style="margin-top:6px;display:' + (doorIsOther?'block':'none') + '" value="' + (doorIsOther?item.doors:'') + '" oninput="setField(' + id + ',\'doors\',this.value)">';
  h += '</div>';

  // Designer CTA
  h += '<div class="designer-cta">';
  h += '<div class="designer-cta-icon">ğŸ“</div>';
  h += '<div class="designer-cta-text"><h3>Front View Designer</h3><p>Draw the layout. W/H/D values entered in the designer auto-fill the dimensions below.</p>' + sketchStatus + '</div>';
  h += '<button class="btn btn-red designer-cta-btn" onclick="openSketchDesigner(' + id + ')">' + designerBtnLabel + '</button>';
  h += '</div>';

  // Sketch thumbnail
  h += '<div class="sketch-thumb-box" id="sketch-preview-thumb-' + id + '" style="margin-bottom:18px;' + (hasPNG?'':'display:none') + '">';
  h += '<img id="sketch-thumb-img-' + id + '" src="' + (item.sketchPNG||'') + '" style="width:100%;display:' + (hasPNG?'block':'none') + '" alt="Design">';
  h += '</div>';
  h += '<div id="sketch-empty-' + id + '" style="' + (hasPNG?'display:none':'') + '"></div>';

  // Dimensions
  h += '<div class="tab-section">';
  h += '<div class="tab-section-title">Dimensions <span style="color:var(--text-muted);font-weight:normal;letter-spacing:0;text-transform:none;font-size:9px">â€” auto-filled from designer, or enter manually</span></div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">';
  h += '<div class="form-group"><label>Width mm <span style="color:var(--red-light)">*</span></label><input type="number" id="dim-w-' + id + '" value="' + (item.w||'') + '" placeholder="2400" oninput="setFieldAndPrice(' + id + ',\'w\',this.value)" style="font-size:16px;font-weight:bold"></div>';
  h += '<div class="form-group"><label>Height mm</label><input type="number" id="dim-h-' + id + '" value="' + (item.h||'') + '" placeholder="2260" oninput="setField(' + id + ',\'h\',this.value)" style="font-size:16px;font-weight:bold"></div>';
  h += '<div class="form-group"><label>Depth mm</label><input type="number" id="dim-d-' + id + '" value="' + (item.d||'') + '" placeholder="600" oninput="setField(' + id + ',\'d\',this.value)" style="font-size:16px;font-weight:bold"></div>';
  h += '</div>';
  h += '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:11px;color:var(--text-muted)">Units:</span>';
  h += '<div class="counter" style="margin:0"><button onclick="changeUnits(' + id + ',-1)">âˆ’</button><span id="units-' + id + '">' + item.units + '</span><button onclick="changeUnits(' + id + ',1)">+</button></div></div>';
  h += '</div>';

  // Bespoke notes
  h += '<div class="form-group" style="margin-top:14px"><label>Bespoke / Site Notes</label>';
  h += '<textarea placeholder="Ceiling slope, chimney breast, special requirements..." rows="2" oninput="setField(' + id + ',\'bespokeNotes\',this.value)">' + (item.bespokeNotes||'') + '</textarea></div>';
  h += '</div>'; // end design tab

  // â”€â”€ FINISH TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  h += '<div id="tab-finish-' + id + '" class="item-tab-body" style="display:' + (activeTab==='finish'?'block':'none') + '">';

  h += '<div class="tab-section">';
  h += '<div class="tab-section-title">Door Style' + (isSliding?' â€” Sliding (handleless)':' â€” Hinged') + '</div>';
  h += doorGalleryBlock;
  h += '</div>';

  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">';
  h += '<div class="form-group"><label>Surface Finish</label><div class="toggle-group" style="margin-top:4px">' + finishOpts + '</div>';
  h += '<input type="text" id="oth-finish-' + id + '" placeholder="e.g. Silk, Woodgrain..." style="margin-top:6px;display:' + (item.finish&&item.finish!=='Matt'&&item.finish!=='Gloss'?'block':'none') + '" value="' + (item.finish&&item.finish!=='Matt'&&item.finish!=='Gloss'?item.finish:'') + '" oninput="setField(' + id + ',\'finish\',this.value)"></div>';
  h += '<div class="form-group"><label>' + handleLabel + '</label><div class="toggle-group" style="margin-top:4px">' + handleOpts + '</div></div>';
  h += '</div>';

  h += '<div class="tab-section">';
  h += '<div class="tab-section-title">Board Colour â€” Egger / Kronospan</div>';
  h += '<div class="swatch-grid" id="swatches-' + id + '">' + swatches + '</div>';
  h += '<input type="text" style="margin-top:8px" value="' + (item.customColour||'') + '" placeholder="Custom board ref â€” e.g. Egger U201" oninput="setField(' + id + ',\'customColour\',this.value)">';
  h += colourStatus;
  h += '</div>';
  h += '</div>'; // end finish tab

  // â”€â”€ INTERIOR TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  h += '<div id="tab-interior-' + id + '" class="item-tab-body" style="display:' + (activeTab==='interior'?'block':'none') + '">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">';
  h += '<div class="form-group"><label>Interior Colour</label><div class="toggle-group" style="margin-top:4px">' + interiorOpts + '</div></div>';
  h += '<div class="form-group"><label>Hanging Rails</label><div class="toggle-group" style="margin-top:4px">' + railOpts + '</div></div>';
  h += '</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">';
  h += '<div class="form-group"><label>Shelves</label><div class="counter" style="margin-top:6px"><button onclick="changeShelves(' + id + ',-1)">âˆ’</button><span id="shelves-' + id + '">' + item.shelves + '</span><button onclick="changeShelves(' + id + ',1)">+</button></div></div>';
  h += '<div class="form-group"><label>Drawer Packs <span style="color:var(--text-muted);font-size:9px">(Â£140 each)</span></label><input type="number" min="0" max="20" value="' + (parseInt(item.drawers)||0) + '" placeholder="0" oninput="setFieldAndPrice(' + id + ',\'drawers\',this.value)" style="font-size:20px;text-align:center;font-weight:bold;padding:8px;margin-top:4px"></div>';
  h += '</div>';
  h += '<div class="form-group"><label>Accessories</label><div class="toggle-group" style="margin-top:4px" id="addons-' + id + '">' + addons + '</div>';
  h += '<input type="text" id="oth-addons-' + id + '" placeholder="Other accessories..." style="margin-top:8px" value="' + (item.customAddon||'') + '" oninput="setField(' + id + ',\'customAddon\',this.value)"></div>';
  h += '</div>'; // end interior tab

  // â”€â”€ PRICE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  h += '<div id="tab-price-' + id + '" class="item-tab-body" style="display:' + (activeTab==='price'?'block':'none') + '">';
  h += '<div id="price-breakdown-' + id + '"></div>';
  h += '</div>'; // end price tab

  return h;
}

function switchTab(id, tab) {
  const item = getItem(id);
  if (!item) return;
  item.activeTab = tab;
  const TABS = ['design','finish','interior','price'];
  TABS.forEach(t => {
    const el = document.getElementById('tab-'+t+'-'+id);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('#item-card-'+id+' .item-tab').forEach((b, i) => {
    b.classList.toggle('active', TABS[i] === tab);
  });
  if (tab === 'price') buildPriceBreakdown(id);
}

function getLayoutSVG(key) {
  const s = {stroke:'#c0392b', fill:'rgba(192,57,43,0.08)', dark:'rgba(192,57,43,0.25)', text:'#c0392b'};
  const svgs = {
    hanging_only: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="50" y1="2" x2="50" y2="78" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="3"/>
      <line x1="2" y1="14" x2="98" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="50" y="11" text-anchor="middle" font-size="8" fill="${s.text}">rail</text>
      <line x1="15" y1="14" x2="15" y2="72" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
      <line x1="85" y1="14" x2="85" y2="72" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
    </svg>`,
    double_hang: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="2" y1="14" x2="98" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="50" y="11" text-anchor="middle" font-size="7" fill="${s.text}">rail</text>
      <line x1="2" y1="44" x2="98" y2="44" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="50" y="41" text-anchor="middle" font-size="7" fill="${s.text}">rail</text>
      <line x1="14" y1="14" x2="14" y2="72" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
      <line x1="86" y1="14" x2="86" y2="72" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
    </svg>`,
    half_half: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="50" y1="2" x2="50" y2="78" stroke="${s.stroke}" stroke-width="1.5"/>
      <line x1="2" y1="14" x2="48" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="25" y="11" text-anchor="middle" font-size="7" fill="${s.text}">long hang</text>
      <line x1="52" y1="14" x2="98" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <line x1="52" y1="44" x2="98" y2="44" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="75" y="11" text-anchor="middle" font-size="7" fill="${s.text}">dbl hang</text>
    </svg>`,
    shelves_drawers: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="2" y1="22" x2="98" y2="22" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="2" y1="34" x2="98" y2="34" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="2" y1="46" x2="98" y2="46" stroke="${s.stroke}" stroke-width="1.5"/>
      <rect x="8" y="50" width="84" height="9" rx="1" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1"/>
      <rect x="8" y="62" width="84" height="9" rx="1" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1"/>
      <text x="50" y="20" text-anchor="middle" font-size="7" fill="${s.text}">shelves</text>
      <text x="50" y="58" text-anchor="middle" font-size="7" fill="${s.text}">drawers</text>
    </svg>`,
    top_drawers_hang: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <rect x="8" y="6" width="84" height="9" rx="1" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1"/>
      <rect x="8" y="18" width="84" height="9" rx="1" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="2" y1="32" x2="98" y2="32" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="50" y="44" text-anchor="middle" font-size="7" fill="${s.text}">hanging rail</text>
      <line x1="2" y1="40" x2="98" y2="40" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="14" y1="40" x2="14" y2="76" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
      <line x1="86" y1="40" x2="86" y2="76" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
      <text x="50" y="12" text-anchor="middle" font-size="7" fill="${s.text}">top drawers</text>
    </svg>`,
    full_shelves: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="2" y1="18" x2="98" y2="18" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="2" y1="32" x2="98" y2="32" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="2" y1="46" x2="98" y2="46" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="2" y1="60" x2="98" y2="60" stroke="${s.stroke}" stroke-width="1"/>
      <text x="50" y="40" text-anchor="middle" font-size="8" fill="${s.text}">full shelves</text>
    </svg>`,
    island_drawers: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="2" y1="14" x2="35" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <line x1="65" y1="14" x2="98" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <line x1="14" y1="14" x2="14" y2="76" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
      <line x1="86" y1="14" x2="86" y2="76" stroke="${s.stroke}" stroke-width="1" stroke-dasharray="2"/>
      <rect x="30" y="28" width="40" height="42" rx="2" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1.5"/>
      <line x1="30" y1="38" x2="70" y2="38" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="30" y1="48" x2="70" y2="48" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="30" y1="58" x2="70" y2="58" stroke="${s.stroke}" stroke-width="1"/>
      <text x="50" y="26" text-anchor="middle" font-size="7" fill="${s.text}">island</text>
    </svg>`,
    his_hers: `<svg viewBox="0 0 100 80" style="width:100%;height:100%">
      <rect x="2" y="2" width="96" height="76" rx="3" fill="${s.fill}" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="50" y1="2" x2="50" y2="78" stroke="${s.stroke}" stroke-width="2"/>
      <line x1="2" y1="14" x2="48" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <rect x="8" y="40" width="36" height="8" rx="1" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1"/>
      <rect x="8" y="51" width="36" height="8" rx="1" fill="${s.dark}" stroke="${s.stroke}" stroke-width="1"/>
      <line x1="52" y1="14" x2="98" y2="14" stroke="${s.stroke}" stroke-width="1.5"/>
      <line x1="52" y1="44" x2="98" y2="44" stroke="${s.stroke}" stroke-width="1.5"/>
      <text x="25" y="36" text-anchor="middle" font-size="7" fill="${s.text}">His</text>
      <text x="75" y="36" text-anchor="middle" font-size="7" fill="${s.text}">Hers</text>
    </svg>`,
  };
  return svgs[key] || '';
}

function applyLayout(id, key) {
  const item = getItem(id);
  if (!item) return;
  item.layoutPreset = key;
  // Apply sensible defaults based on layout
  const presets = {
    hanging_only:     { rails:'Long Hang (Full Height)', shelves:2, drawers:'No Drawers' },
    double_hang:      { rails:'Double Hang', shelves:2, drawers:'No Drawers' },
    half_half:        { rails:'Half & Half', shelves:4, drawers:'No Drawers' },
    shelves_drawers:  { rails:'No Rails', shelves:6, drawers:'4 Drawers' },
    top_drawers_hang: { rails:'Long Hang (Full Height)', shelves:2, drawers:'2 Drawers' },
    full_shelves:     { rails:'No Rails', shelves:10, drawers:'No Drawers' },
    island_drawers:   { rails:'Long Hang (Full Height)', shelves:2, drawers:'Full Drawer Bank' },
    his_hers:         { rails:'Half & Half', shelves:4, drawers:'2 Drawers' },
  };
  const p = presets[key];
  if (p) { item.rails=p.rails; item.shelves=p.shelves; item.drawers=p.drawers; }
  // Re-render the layout grid to show selection
  const grid = document.getElementById('layout-grid-'+id);
  if (grid) grid.querySelectorAll('.layout-card').forEach(card => {
    const isSelected = card.getAttribute('onclick').includes("'"+key+"'");
    card.style.borderColor = isSelected ? 'var(--red)' : 'var(--border)';
    const label = card.querySelector('div:nth-child(2)');
    if (label) label.style.color = isSelected ? 'var(--red-light)' : 'var(--text)';
  });
  updateGrandTotal();
  toast('Layout applied: ' + key.replace(/_/g,' '));
}

function setFieldAndRender(id, field, val) {
  setField(id, field, val);
  // Re-render this item card so sliding/hinged label reflects change
  const item = getItem(id);
  if (!item) return;
  const idx = items.findIndex(i => i.id === id);
  const card = document.getElementById('item-card-'+id);
  if (card && idx >= 0) {
    const tab = item.activeTab;
    card.innerHTML = buildItemHTML(item, idx);
    // Restore sketch thumbnail
    const png = item.sketchPNG || (item.sketchHistory&&item.sketchHistory[0]&&item.sketchHistory[0].data);
    if (png) {
      const thumb = document.getElementById('sketch-thumb-img-'+id);
      const preview = document.getElementById('sketch-preview-thumb-'+id);
      const empty = document.getElementById('sketch-empty-'+id);
      if (thumb) { thumb.src = png; thumb.style.display = 'block'; }
      if (preview) preview.style.display = 'block';
      if (empty) empty.style.display = 'none';
    }
    // Re-open correct tab
    switchTab(id, tab);
    // Reattach swatches colour
    if (item.colour) setColour(id, item.colour.code);
  }
  // Update sketch sliding flag
  if (field === 'type') {
    skState.isSliding = SLIDING_TYPES.includes(val);
    skRedraw();
  }
}

function setFieldAndPrice(id, field, val) {
  setField(id, field, val);
  if (document.getElementById('tab-price-'+id) && getItem(id)?.activeTab==='price') {
    buildPriceBreakdown(id);
  }
  updateGrandTotal();
}

function setField(id, field, val) {
  const item = getItem(id);
  if (!item) return;
  item[field] = val;
  // update toggle visuals
  const card = document.getElementById(`item-card-${id}`);
  if (card) {
    card.querySelectorAll('.toggle-opt').forEach(el => {
      const oc = el.getAttribute('onclick') || '';
      if (oc.includes(`'${field}'`)) {
        el.classList.toggle('selected', el.textContent.trim() === val);
      }
    });
  }
  refreshBadge(id);
  updateGrandTotal();
}

function setFieldOther(id, field, val, otherId) {
  const otherInput = document.getElementById(otherId);
  if (val === '__other__') {
    if (otherInput) { otherInput.style.display = 'block'; otherInput.focus(); }
    // clear the field so nothing is selected until they type
    const item = getItem(id);
    if (item) item[field] = '';
    // deselect all toggles in that group
    const card = document.getElementById(`item-card-${id}`);
    if (card) card.querySelectorAll('.toggle-opt').forEach(el => {
      const oc = el.getAttribute('onclick') || '';
      if (oc.includes(`'${field}'`)) el.classList.remove('selected');
    });
    // mark the Other button selected
    const tg = document.getElementById(`tg-${otherId}`);
    if (tg) { const last = tg.querySelector('.toggle-opt:last-child'); if (last) last.classList.add('selected'); }
    return;
  }
  if (otherInput) otherInput.style.display = 'none';
  setField(id, field, val);
}

function setColour(id, code) {
  document.querySelectorAll(`#swatches-${id} .swatch`).forEach(s => {
    const oc = s.getAttribute('onclick') || '';
    s.classList.toggle('selected', oc.includes(`'${code}'`));
  });
}

function toggleAddon(id, val) {
  const item = getItem(id);
  if (!item) return;
  if (item.addons.includes(val)) item.addons = item.addons.filter(v => v !== val);
  else item.addons.push(val);
  document.querySelectorAll(`#addons-${id} .toggle-opt`).forEach(el => {
    el.classList.toggle('selected', item.addons.includes(el.textContent.trim()));
  });
  refreshBadge(id);
  updateGrandTotal();
}

function changeUnits(id, d) {
  const item = getItem(id);
  if (!item) return;
  item.units = Math.max(1, Math.min(10, item.units + d));
  const el = document.getElementById(`units-${id}`);
  if (el) el.textContent = item.units;
  refreshBadge(id); updateGrandTotal();
}

function changeShelves(id, d) {
  const item = getItem(id);
  if (!item) return;
  item.shelves = Math.max(0, Math.min(20, item.shelves + d));
  const el = document.getElementById(`shelves-${id}`);
  if (el) el.textContent = item.shelves;
  updateGrandTotal();
}

function refreshBadge(id) {
  const item = getItem(id);
  const el = document.getElementById(`badge-${id}`);
  if (!item || !el) return;
  const base = calcItemPrice(item);
  const total = base + Math.round(base * 0.2);
  el.textContent = total > 0 ? `Â£${total.toLocaleString()} inc. VAT` : '';
  // update header title
  const card = document.getElementById(`item-card-${id}`);
  if (card) {
    const title = card.querySelector('.item-card-title');
    if (title) title.textContent = `Item ${items.findIndex(i=>i.id===id)+1} â€” ${item.room}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Extra price table â€” keyed by addon name
// Hinged door styles â€” grouped by style type
// Images load from browns2000.co.uk when online; fallback bg colour shown offline
const DOOR_STYLE_GALLERY = [
  // â”€â”€â”€ SHAKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {group:'Shaker', popular:true,  name:'Hampton â€” Ultra Matt Graphite',   bg:'#4a4a4a', img:'https://www.browns2000.co.uk/_assets/media/showroom/1158.jpg?v26012025', sub:'Ultra Matt Â· Dark Graphite'},
  {group:'Shaker', popular:true,  name:'Hampton â€” Ultra Matt Mussel',     bg:'#c0a882', img:'https://www.browns2000.co.uk/_assets/media/showroom/96.jpg?v26012025',   sub:'Ultra Matt Â· Warm Mussel'},
  {group:'Shaker', popular:false, name:'Bamburgh â€” Ultra Matt White',     bg:'#f5f5f5', img:'https://www.browns2000.co.uk/_assets/media/showroom/1146.jpg?v26012025', sub:'Ultra Matt Â· Bright White'},
  {group:'Shaker', popular:false, name:'Glendale â€” Ultra Matt Pale Cream',bg:'#f0ece0', img:'https://www.browns2000.co.uk/_assets/media/showroom/97.jpg?v26012025',  sub:'Ultra Matt Â· Pale Cream'},
  {group:'Shaker', popular:false, name:'Turnberry â€” Ultra Matt Cashmere', bg:'#d4b896', img:'https://www.browns2000.co.uk/_assets/media/showroom/1157.jpg?v26012025', sub:'Ultra Matt Â· Cashmere'},
  {group:'Shaker', popular:false, name:'Chester â€” White Oak',             bg:'#ddd0b8', img:'https://www.browns2000.co.uk/_assets/media/showroom/101.jpg?v26012025',  sub:'Traditional Â· White Oak'},
  // â”€â”€â”€ SLAB / HANDLELESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {group:'Slab / Handleless', popular:false, name:'Glacier â€” High Gloss White',      bg:'#f8f8f8', img:'https://www.browns2000.co.uk/_assets/media/showroom/88.jpg?v26012025',   sub:'High Gloss Â· White'},
  {group:'Slab / Handleless', popular:false, name:'Glacier â€” High Gloss Cashmere',   bg:'#e8dcc8', img:'https://www.browns2000.co.uk/_assets/media/showroom/87.jpg?v26012025',   sub:'High Gloss Â· Cashmere'},
  {group:'Slab / Handleless', popular:false, name:'Glacier â€” Super Matt Light Grey', bg:'#c0c0c0', img:'https://www.browns2000.co.uk/_assets/media/showroom/92.jpg?v26012025',   sub:'Super Matt Â· Light Grey'},
  {group:'Slab / Handleless', popular:false, name:'Glacier â€” Super Matt Black',      bg:'#1a1a1a', img:'https://www.browns2000.co.uk/_assets/media/showroom/1145.jpg?v26012025', sub:'Super Matt Â· Black'},
  {group:'Slab / Handleless', popular:false, name:'Glacier â€” Super Matt Graphite',   bg:'#3c3c3c', img:'https://www.browns2000.co.uk/_assets/media/showroom/94.jpg?v26012025',   sub:'Super Matt Â· Graphite'},
  {group:'Slab / Handleless', popular:false, name:'Monaco â€” Light Concrete',         bg:'#c0bcb4', img:'https://www.browns2000.co.uk/_assets/media/showroom/1130.jpg?v26012025', sub:'Concrete Texture'},
  // â”€â”€â”€ WOODGRAIN / OAK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {group:'Woodgrain / Oak', popular:false, name:'Matfen â€” Light Grey Oak',       bg:'#b8b4a8', img:'https://www.browns2000.co.uk/_assets/media/showroom/95.jpg?v26012025',   sub:'Light Grey Oak & Graphite Oak'},
  {group:'Woodgrain / Oak', popular:false, name:'Matfen â€” Parisian Blue Oak',    bg:'#6080a0', img:'https://www.browns2000.co.uk/_assets/media/showroom/1148.jpg?v26012025', sub:'Parisian Blue Oak'},
  {group:'Woodgrain / Oak', popular:false, name:'Matfen â€” Dust Grey Oak',        bg:'#909090', img:'https://www.browns2000.co.uk/_assets/media/showroom/126.jpg?v26012025',  sub:'Dust Grey & Light Grey Oak'},
  {group:'Woodgrain / Oak', popular:false, name:'Portree â€” White Oak',           bg:'#e0d0b8', img:'https://www.browns2000.co.uk/_assets/media/showroom/1143.jpg?v26012025', sub:'Panelled Â· White Oak'},
  // â”€â”€â”€ ROUTED / SCULPTED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {group:'Routed / Sculpted', popular:false, name:'Scoop â€” Ultra Matt Light Grey', bg:'#c0c0c0', img:'https://www.browns2000.co.uk/_assets/media/showroom/105.jpg?v26012025',  sub:'Curved Routed Profile'},
  {group:'Routed / Sculpted', popular:false, name:'Eclipse â€” Ultra Matt White',    bg:'#f0f0f0', img:'https://www.browns2000.co.uk/_assets/media/showroom/103.jpg?v26012025',  sub:'Sculpted Profile Â· White'},
  {group:'Routed / Sculpted', popular:false, name:'Alnwick â€” Ultra Matt White Grey',bg:'#dcdcd0',img:'https://www.browns2000.co.uk/_assets/media/showroom/1132.jpg?v26012025', sub:'Grooved Panel'},
  // â”€â”€â”€ FRAMED / MIRROR / GLASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {group:'Framed / Mirror / Glass', popular:false, name:'Mirror Panel â€” Full',         bg:'linear-gradient(135deg,#e8e8e8 0%,#aaa 40%,#e8e8e8 60%,#bbb 100%)', img:'', sub:'Full mirror door â€” framed or frameless', icon:'ğŸª'},
  {group:'Framed / Mirror / Glass', popular:false, name:'Mirror Panel â€” Part',         bg:'linear-gradient(135deg,#d8d8d8 0%,#999 40%,#d8d8d8 100%)',           img:'', sub:'Part mirror insert in frame',             icon:'ğŸª'},
  {group:'Framed / Mirror / Glass', popular:false, name:'Glass Panel â€” Clear Framed',  bg:'linear-gradient(135deg,#d4eaf8 0%,#88c0e0 50%,#d4eaf8 100%)',        img:'', sub:'Clear glass in aluminium frame',           icon:'ğŸ”²'},
  {group:'Framed / Mirror / Glass', popular:false, name:'Glass Panel â€” Frosted Framed',bg:'linear-gradient(135deg,#e8e8e8 0%,#d0d0d0 50%,#e8e8e8 100%)',        img:'', sub:'Frosted glass in frame',                   icon:'ğŸ”²'},
];

const EXTRA_PRICES = {
  'LED Lighting': 320,
  'Shoe Racks': 180,
  'Trouser Rack': 140,
  'Tie/Belt Rack': 95,
  'Pull-Out Mirror': 220,
  'Soft-Close Runners': 85,
  'Laundry Basket': 160,
  'Safe': 380,
  'Pull-Down Rail': 195,
  'Valet Rod': 65,
  'Jewellery Insert': 145,
  'Glass Shelves (set of 4)': 240,
  'Mirror Back Panel': 310,
};

function getItemRate(item) {
  if (SLIDING_TYPES.includes(item.type)) return RATE_SLIDING;
  if (HINGED_TYPES.includes(item.type)) return RATE_HINGED;
  return RATE_HINGED;
}

function calcItemPrice(item) {
  // Width-per-metre pricing (no height in formula)
  const w = parseInt(item.w) || 0;
  if (!w) return 0;
  const wm = (w / 1000) * (item.units || 1);
  const rate = getItemRate(item);
  let base = wm * rate;
  // Drawer packs
  const drawerCount = parseInt(item.drawers) || 0;
  base += drawerCount * 140;
  // Shelves
  base += (item.shelves || 0) * 45;
  // Named addons
  (item.addons || []).forEach(a => { if (EXTRA_PRICES[a]) base += EXTRA_PRICES[a]; });
  // Custom extras (item.extras array: [{name,price}])
  (item.extras || []).forEach(e => { base += parseFloat(e.price) || 0; });
  // Legacy extraPrice field
  base += parseFloat(item.extraPrice) || 0;
  return Math.round(base);
}

function buildPriceBreakdown(id) {
  const item = getItem(id);
  const el = document.getElementById('price-breakdown-'+id);
  if (!item || !el) return;
  const w = parseInt(item.w) || 0;
  const wm = (w / 1000) * (item.units || 1);
  const rate = getItemRate(item);
  const baseWidth = Math.round(wm * rate);
  const drawerCount = parseInt(item.drawers) || 0;
  const drawerCost = drawerCount * 140;
  const shelfCost = (item.shelves||0) * 45;
  const addonRows = (item.addons||[]).map(a => EXTRA_PRICES[a] ?
    `<div class="price-row"><span class="price-label">+ ${a}</span><span>Â£${EXTRA_PRICES[a].toLocaleString()}</span></div>` : ''
  ).join('');
  const extrasRows = (item.extras||[]).map((e,i) =>
    `<div class="price-row" style="background:rgba(201,168,76,0.05)">
      <span class="price-label" style="display:flex;align-items:center;gap:6px">
        <input style="width:130px;font-size:11px;padding:3px 6px" value="${e.name}" placeholder="Extra item name"
          oninput="updateExtra(${item.id},${i},'name',this.value)">
      </span>
      <span style="display:flex;align-items:center;gap:4px">
        Â£<input style="width:70px;font-size:11px;padding:3px 6px;text-align:right" type="number" value="${e.price}" placeholder="0"
          oninput="updateExtra(${item.id},${i},'price',this.value)">
        <button onclick="removeExtra(${item.id},${i})" style="background:var(--red-dark);color:#fff;border:none;border-radius:4px;padding:2px 7px;cursor:pointer;font-size:11px">âœ•</button>
      </span>
    </div>`
  ).join('');
  const legacyExtra = parseFloat(item.extraPrice)||0;
  const base = calcItemPrice(item);
  const vat = Math.round(base * 0.2);
  const total = base + vat;
  const col = item.customColour || (item.colour ? item.colour.code+' '+item.colour.name+' ('+item.colour.brand+')' : 'â€”');
  el.innerHTML =
    '<div class="price-row"><span class="price-label">Type</span><span>'+item.type+' â€” '+item.room+'</span></div>'+
    '<div class="price-row"><span class="price-label">Width</span><span>'+w+'mm ('+wm.toFixed(2)+'m)</span></div>'+
    '<div class="price-row" style="background:rgba(192,57,43,0.05)"><span class="price-label">Rate</span><span>Â£'+rate+'/m width ('+item.type+')</span></div>'+
    '<div class="price-row" style="font-weight:bold"><span class="price-label">Width Charge</span><span>Â£'+baseWidth.toLocaleString()+'</span></div>'+
    (drawerCost?'<div class="price-row"><span class="price-label">Drawers ('+drawerCount+'Ã—)</span><span>Â£'+drawerCost.toLocaleString()+'</span></div>':'')+
    (shelfCost?'<div class="price-row"><span class="price-label">Shelves ('+item.shelves+'Ã—)</span><span>Â£'+shelfCost.toLocaleString()+'</span></div>':'')+
    addonRows+extrasRows+
    (legacyExtra?'<div class="price-row"><span class="price-label">Additional Charge</span><span>Â£'+legacyExtra.toLocaleString()+'</span></div>':'')+
    '<div class="price-row" style="padding-top:6px"><span></span><button onclick="addExtra('+item.id+')" class="btn btn-outline btn-sm" style="font-size:10px">+ Add Custom Extra</button></div>'+
    '<div class="divider"></div>'+
    '<div class="price-row"><span class="price-label">Sub-total (ex. VAT)</span><span>Â£'+base.toLocaleString()+'</span></div>'+
    '<div class="price-row"><span class="price-label">VAT (20%)</span><span>Â£'+vat.toLocaleString()+'</span></div>'+
    '<div class="price-row"><span class="price-label price-total">Item Total (inc. VAT)</span><span class="price-total">Â£'+total.toLocaleString()+'</span></div>';
}

function addExtra(id) {
  const item = getItem(id);
  if (!item) return;
  if (!item.extras) item.extras = [];
  item.extras.push({name:'', price:0});
  buildPriceBreakdown(id);
  updateGrandTotal();
}

function updateExtra(id, idx, field, val) {
  const item = getItem(id);
  if (!item||!item.extras) return;
  item.extras[idx][field] = field==='price' ? parseFloat(val)||0 : val;
  updateGrandTotal();
}

function removeExtra(id, idx) {
  const item = getItem(id);
  if (!item||!item.extras) return;
  item.extras.splice(idx,1);
  buildPriceBreakdown(id);
  updateGrandTotal();
}

function calcGrand() {
  const disc = parseFloat(document.getElementById('discount-amt')?.value) || 0;
  const sub = items.reduce((s, i) => s + calcItemPrice(i), 0);
  const after = Math.max(0, sub - disc);
  const vat = Math.round(after * 0.2);
  const total = after + vat;
  const rec = Math.round(total * 0.5);
  return { sub, disc, after, vat, total, rec };
}

function updateGrandTotal() {
  const g = calcGrand();
  // dep-recommended removed from UI â€” no-op
  const gtEl = document.getElementById('grand-total-display');
  if (gtEl) {
  var grandItemLines = items.map(function(item,i){
    var b = calcItemPrice(item);
    return b>0 ? '<div style="font-size:12px;color:rgba(255,255,255,0.7)">Item '+(i+1)+' ('+item.room+'): Â£'+(b+Math.round(b*0.2)).toLocaleString()+' inc.VAT</div>' : '';
  }).join('');
  var discLine = g.disc ? '<div style="font-size:12px;color:#f5b041">Discount: âˆ’Â£'+g.disc.toLocaleString()+'</div>' : '';
  gtEl.innerHTML = '<div class="grand-bar"><div>' +
    '<div style="font-size:11px;color:rgba(255,255,255,0.5);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Grand Total</div>' +
    grandItemLines + discLine +
    '</div><div style="text-align:right">' +
    '<div style="font-size:32px;font-weight:bold;color:#fff">Â£' + g.total.toLocaleString() + '</div>' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.5)">inc. VAT</div>' +
    '</div></div>';
  }
  const actual = parseInt(document.getElementById('deposit-actual')?.value) || 0;
  const balEl = document.getElementById('balance-breakdown');
  if (balEl) {
    balEl.innerHTML = actual > 0 ? `
      <div class="price-row"><span class="price-label">Deposit Taken Today</span><span style="color:#58d68d;font-weight:bold">Â£${actual.toLocaleString()}</span></div>
      <div class="price-row"><span class="price-label">Balance Due on Installation</span><span style="color:var(--gold);font-size:20px;font-weight:bold">Â£${Math.max(0,g.total-actual).toLocaleString()}</span></div>` : '';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKETCH TOOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKETCH DESIGNER â€” GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let skState = {
  tool: 'select', colour: '#1a1a1a', size: 2,
  drawing: false, sx: 0, sy: 0, path: [],
  shapes: [],      // persistent shapes array
  activeItemId: null,
  selected: null,  // index of selected shape
  canvasW: 900, canvasH: 560,
  scale: 1, offsetX: 0, offsetY: 0
};
let skDirty = false;

function openSketchDesigner(itemId) {
  // Pick item: passed ID or first item
  const id = itemId || (items.length > 0 ? items[0].id : null);
  if (!id) { toast('Add an item first'); return; }
  skState.activeItemId = id;
  // Load existing sketch shapes for this item
  const item = getItem(id);
  skState.shapes = (item && item.sketchShapes) ? JSON.parse(JSON.stringify(item.sketchShapes)) : [];
  skState.isSliding = item && (item.type==='Sliding Door Fitted'||item.type==='Sliding Door Walk-In');
  skDirty = false;
  // Build item selector tabs
  const sel = document.getElementById('sk-item-selector');
  sel.innerHTML = items.map(it =>
    '<button class="sketch-item-btn'+(it.id===id?' active':'')+'" onclick="skSwitchItem('+it.id+')" id="sk-itab-'+it.id+'">'+
    'Item '+(items.indexOf(it)+1)+' â€” '+it.room+'</button>'
  ).join('');
  const ov = document.getElementById('sketch-overlay');
  ov.classList.add('open');
  // Force layout recalc to ensure overlay is full screen before sizing canvas
  ov.style.display = 'flex';
  ov.style.width = window.innerWidth + 'px';
  ov.style.height = window.innerHeight + 'px';
  document.addEventListener('keydown', skKeyDown);
  setTimeout(skInitCanvas, 150);
  // Re-init on window resize
  window.addEventListener('resize', function() {
    const ov = document.getElementById('sketch-overlay');
    if (ov && ov.classList.contains('open')) {
      ov.style.width = window.innerWidth + 'px';
      ov.style.height = window.innerHeight + 'px';
      setTimeout(skInitCanvas, 60);
    }
  });
}

function skSwitchItem(id) {
  // Save current before switching
  skSaveShapes(skState.activeItemId);
  skState.activeItemId = id;
  const item = getItem(id);
  skState.shapes = (item && item.sketchShapes) ? JSON.parse(JSON.stringify(item.sketchShapes)) : [];
  skState.isSliding = item && (item.type==='Sliding Door Fitted'||item.type==='Sliding Door Walk-In');
  document.querySelectorAll('.sketch-item-btn').forEach(b => b.classList.remove('active'));
  const tab = document.getElementById('sk-itab-'+id);
  if (tab) tab.classList.add('active');
  skRedraw();
}

function closeSketchDesigner() {
  if (skDirty && !confirm('Save design before closing?')) { skSaveToItem(); }
  document.getElementById('sketch-overlay').classList.remove('open');
  document.removeEventListener('keydown', skKeyDown);
}


function skPrintFactory() {
  // Auto-save first
  skSaveToItem();
  const id = skState.activeItemId;
  const item = getItem(id);
  const png = item && item.sketchPNG ? item.sketchPNG : null;
  // Gather customer info from quote form
  const firstName = document.getElementById('c-first')?.value || '';
  const lastName  = document.getElementById('c-last')?.value  || '';
  const phone     = document.getElementById('c-phone')?.value || '';
  const address   = document.getElementById('c-address')?.value || '';
  const agent     = document.getElementById('c-surveyor')?.value || '';
  const custName  = (firstName+' '+lastName).trim() || 'â€”';
  // Item spec
  const col = (item&&item.customColour) ? item.customColour
    : (item&&item.colour ? item.colour.code+' '+item.colour.name+' ('+item.colour.brand+')' : 'â€”');
  const today = new Date().toLocaleDateString('en-GB');
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>Factory Sheet â€” ${custName}</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#fff;color:#111;padding:18mm 15mm;font-size:11pt}
    .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;padding-bottom:10px;border-bottom:3px solid #c0392b}
    .logo{font-size:18pt;font-weight:bold;color:#c0392b;letter-spacing:2px}
    .logo-sub{font-size:8pt;color:#888;letter-spacing:2px;text-transform:uppercase}
    .ref{text-align:right;font-size:9pt;color:#888}
    .ref strong{font-size:14pt;color:#c0392b;display:block}
    h2{font-size:10pt;text-transform:uppercase;letter-spacing:2px;color:#c0392b;margin:12px 0 6px;padding-bottom:3px;border-bottom:1px solid #f5b7b1}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 18px;margin-bottom:10px}
    .row{display:flex;gap:6px;padding:4px 0;border-bottom:1px solid #f0f0f0;font-size:10.5pt}
    .lbl{font-weight:bold;min-width:140px;color:#555}
    .val{color:#111}
    .sketch-box{border:2px solid #c0392b;border-radius:4px;overflow:hidden;margin:10px 0;text-align:center;background:#fafafa}
    .sketch-box img{width:100%;display:block}
    .sketch-box .no-sketch{padding:40px;color:#888;font-size:10pt}
    .footer{margin-top:14px;padding-top:8px;border-top:1px solid #eee;font-size:8.5pt;color:#888;display:flex;justify-content:space-between}
    .sig-area{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:14px}
    .sig-box{border-top:1.5px solid #111;padding-top:6px;font-size:9pt;color:#555}
    @page{size:A4;margin:0}
    @media print{body{padding:10mm 10mm}}
  </style></head><body>
  <div class="header">
    <div>
      <div class="logo">LUXURY HOUSE</div>
      <div class="logo-sub">Luxury Fitted Wardrobes Â· Factory Production Sheet</div>
    </div>
    <div class="ref">
      <strong>FACTORY SHEET</strong>
      Date: ${today}<br>Agent: ${agent||'â€”'}
    </div>
  </div>

  <h2>Customer Details</h2>
  <div class="grid">
    <div class="row"><span class="lbl">Customer Name</span><span class="val">${custName}</span></div>
    <div class="row"><span class="lbl">Phone</span><span class="val">${phone||'â€”'}</span></div>
    <div class="row" style="grid-column:1/-1"><span class="lbl">Installation Address</span><span class="val">${address||'â€”'}</span></div>
  </div>

  <h2>Item Specification â€” ${item?(item.type||'Wardrobe'):''} Â· ${item?item.room:''}</h2>
  <div class="grid">
    <div class="row"><span class="lbl">Type</span><span class="val">${item?item.type:'â€”'}</span></div>
    <div class="row"><span class="lbl">Room</span><span class="val">${item?item.room:'â€”'}</span></div>
    <div class="row"><span class="lbl">Door Config</span><span class="val">${item?item.doors:'â€”'}</span></div>
    <div class="row"><span class="lbl">Door Style</span><span class="val">${item?item.doorStyle:'â€”'}</span></div>
    <div class="row"><span class="lbl">Finish</span><span class="val">${item?item.finish:'â€”'}</span></div>
    <div class="row"><span class="lbl">Board Colour</span><span class="val">${col}</span></div>
    <div class="row"><span class="lbl">Handle</span><span class="val">${item?item.handles:'â€”'}</span></div>
    <div class="row"><span class="lbl">Interior Colour</span><span class="val">${item?item.interiorFinish:'â€”'}</span></div>
    <div class="row"><span class="lbl">Hanging Rails</span><span class="val">${item?item.rails:'â€”'}</span></div>
    <div class="row"><span class="lbl">Shelves</span><span class="val">${item?item.shelves:'â€”'}</span></div>
    <div class="row"><span class="lbl">Drawer Packs</span><span class="val">${item?(parseInt(item.drawers)||0):0}</span></div>
    <div class="row"><span class="lbl">Width (mm)</span><span class="val">${item&&item.w?item.w+'mm':'â€”'}</span></div>
    <div class="row"><span class="lbl">Height (mm)</span><span class="val">${item&&item.h?item.h+'mm':'â€”'}</span></div>
    <div class="row"><span class="lbl">Depth (mm)</span><span class="val">${item&&item.d?item.d+'mm':'â€”'}</span></div>
    ${item&&item.addons&&item.addons.length?'<div class="row" style="grid-column:1/-1"><span class="lbl">Accessories</span><span class="val">'+item.addons.join(', ')+'</span></div>':''}
    ${item&&item.bespokeNotes?'<div class="row" style="grid-column:1/-1"><span class="lbl">âš ï¸ Bespoke Notes</span><span class="val" style="color:#c0392b;font-weight:bold">'+item.bespokeNotes+'</span></div>':''}
  </div>

  <h2>Front View Design Sketch</h2>
  <div class="sketch-box">
    ${png ? '<img src="'+png+'" alt="Design Sketch">' : '<div class="no-sketch">No sketch saved â€” save design first</div>'}
  </div>

  <div class="sig-area">
    <div class="sig-box">Production Sign-Off: _______________________<br><br>Date: _______________</div>
    <div class="sig-box">Quality Check: _______________________<br><br>Date: _______________</div>
  </div>

  <div class="footer">
    <span>Luxury House | Luxury Fitted Wardrobes | www.luxuryhouseonline.com</span>
    <span>Printed: ${today}</span>
  </div>
  <script>window.onload=function(){window.print();}<\/script>
  </body></html>`;

  const w = window.open('','_blank','width=900,height=700');
  if (w) { w.document.write(html); w.document.close(); }
  else { toast('Please allow popups to print factory sheet'); }
}

function skSaveToItem() {
  const id = skState.activeItemId;
  if (!id) return;
  skSaveShapes(id);

  // â”€â”€ Extract dimensions from sketch text labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Scan all text shapes for W: / H: / D: patterns and sync to item
  const item = getItem(id);
  if (item) {
    skState.shapes.forEach(function(s) {
      if (s.type !== 'text') return;
      const t = s.text || '';
      // Match patterns like "W: 2400 mm", "Width: 2400mm", "Width: 2400"
      const wm = t.match(/^W(?:idth)?[:\s]+([\d.]+)/i);
      const hm = t.match(/^H(?:eight)?[:\s]+([\d.]+)/i);
      const dm = t.match(/^D(?:epth)?[:\s]+([\d.]+)/i);
      if (wm && wm[1] && parseFloat(wm[1]) > 0) { item.w = wm[1]; }
      if (hm && hm[1] && parseFloat(hm[1]) > 0) { item.h = hm[1]; }
      if (dm && dm[1] && parseFloat(dm[1]) > 0) { item.d = dm[1]; }
    });
    // Update the dimension input fields on the design tab
    const wEl = document.getElementById('dim-w-'+id);
    const hEl = document.getElementById('dim-h-'+id);
    const dEl = document.getElementById('dim-d-'+id);
    if (wEl) wEl.value = item.w || '';
    if (hEl) hEl.value = item.h || '';
    if (dEl) dEl.value = item.d || '';
  }

  // Render to PNG and save
  const c = document.getElementById('sk-main-canvas');
  if (c) {
    const png = c.toDataURL('image/png');
    if (item) {
      item.sketchPNG = png;
      item.sketchHistory = [{ type: 'png', data: png }];
    }
    // Update thumbnail
    const thumb = document.getElementById('sketch-thumb-img-'+id);
    const preview = document.getElementById('sketch-preview-thumb-'+id);
    const empty = document.getElementById('sketch-empty-'+id);
    if (thumb) { thumb.src = png; thumb.style.display = 'block'; }
    if (preview) preview.style.display = 'block';
    if (empty) empty.style.display = 'none';
    // Update item header subtitle
    if (item) {
      const card = document.getElementById('item-card-'+id);
      if (card) {
        const sub = card.querySelector('.item-card-subtitle');
        if (sub) sub.textContent = (item.type||'') + ' Â· ' + (item.doors||'') + ' Â· ' + (item.w?item.w+'mm wide':'');
      }
    }
  }
  skDirty = false;
  document.getElementById('sketch-overlay').classList.remove('open');
  document.getElementById('sketch-overlay').style.width = '';
  document.getElementById('sketch-overlay').style.height = '';
  const dimsFound = item && (item.w || item.h || item.d);
  toast('Design saved' + (dimsFound ? ' â€” dimensions synced to item' : '') + '!');
}

function skSaveShapes(id) {
  const item = getItem(id);
  if (item) item.sketchShapes = JSON.parse(JSON.stringify(skState.shapes));
}

// â”€â”€ Canvas init & resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skInitCanvas() {
  requestAnimationFrame(function() {
  const c = document.getElementById('sk-main-canvas');
  if (!c) return;
  const area = document.querySelector('.sketch-canvas-area');
  if (!area) return;
  const pad = 20;
  const maxW = area.clientWidth - pad;
  const maxH = area.clientHeight - pad;
  if (maxW < 100 || maxH < 100) { setTimeout(skInitCanvas, 100); return; }
  const ratio = 16/9;
  let w = maxW;
  let h = Math.round(w / ratio);
  if (h > maxH) { h = maxH; w = Math.round(h * ratio); }
  w = Math.max(w, 400); h = Math.max(h, 250);
  c.width = w; c.height = h;
  const wrap = c.parentElement;
  if (wrap) { wrap.style.width = w + 'px'; wrap.style.height = h + 'px'; }
  skState.canvasW = w; skState.canvasH = h;
  if (!c._skinit) {
    c.addEventListener('mousedown', skDown);
    c.addEventListener('mousemove', skMove);
    c.addEventListener('mouseup', skUp);
    c.addEventListener('mouseleave', skUp);
    c.addEventListener('dblclick', skDblClick);
    c.addEventListener('touchstart', function(e){ e.preventDefault(); skDown(e); }, {passive:false});
    c.addEventListener('touchmove', function(e){ e.preventDefault(); skMove(e); }, {passive:false});
    c.addEventListener('touchend', function(e){ e.preventDefault(); skUp(e); }, {passive:false});
    c._skinit = true;
  }
  skRedraw();
  });
}

function skPos(e) {
  const c = document.getElementById('sk-main-canvas');
  const r = c.getBoundingClientRect();
  const sc = c.width / r.width;
  const src = e.touches ? e.touches[0] : (e.changedTouches ? e.changedTouches[0] : e);
  return { x: (src.clientX - r.left) * sc, y: (src.clientY - r.top) * sc };
}

// â”€â”€ Tool control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skSetTool(t) {
  skState.tool = t;
  document.querySelectorAll('.sk-tool').forEach(b => b.classList.remove('active'));
  const btnId = t === 'door-l' ? 'sktool-door' : 'sktool-'+t;
  const btn = document.getElementById(btnId);
  if (btn) btn.classList.add('active');
  const c = document.getElementById('sk-main-canvas');
  if (c) c.style.cursor = (t==='text'||t==='select') ? 'default' : 'crosshair';
}

function skSetColour(col, el) {
  skState.colour = col;
  document.querySelectorAll('.sk-colour').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
}

function skSetSize(sz) {
  skState.size = sz;
  document.querySelectorAll('.sk-size').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('sksize-'+sz);
  if (btn) btn.classList.add('active');
}

// â”€â”€ Mouse/touch events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Pinch-to-resize state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let skPinch = { active:false, startDist:0, shapeIdx:null, origShape:null };

function skPinchDist(e) {
  const t = e.touches;
  return Math.hypot(t[0].clientX-t[1].clientX, t[0].clientY-t[1].clientY);
}

function skDown(e) {
  // Pinch-to-resize: two fingers on a selected shape
  if (e.touches && e.touches.length === 2 && skState.selected !== null) {
    skPinch.active = true;
    skPinch.startDist = skPinchDist(e);
    skPinch.shapeIdx = skState.selected;
    skPinch.origShape = JSON.parse(JSON.stringify(skState.shapes[skState.selected]));
    return;
  }
  const p = skPos(e);
  skState.sx = p.x; skState.sy = p.y;
  skState.drawing = true;
  skDirty = true;
  if (skState.tool === 'text') {
    const label = document.getElementById('sk-label-input').value.trim();
    if (!label) { toast('Type a label in the sidebar first'); skState.drawing=false; return; }
    skState.shapes.push({ type:'text', x:p.x, y:p.y, text:label, colour:skState.colour, size:skState.size });
    skState.drawing = false;
    skRedraw(); return;
  }
  if (skState.tool === 'lasso') {
    // Check if clicking inside an existing group to drag it
    if (skState.selectedGroup.length > 0) {
      const inGroup = skState.selectedGroup.some(i => skHitTest(skState.shapes[i], p.x, p.y));
      if (inGroup) {
        skState.groupDragStart = p;
        skState.groupOrigShapes = skState.selectedGroup.map(i => JSON.parse(JSON.stringify(skState.shapes[i])));
        skState.drawing = false;
        return;
      }
    }
    // Start new lasso
    skState.lasso = {x1:p.x, y1:p.y, x2:p.x, y2:p.y};
    skState.selectedGroup = [];
    skState.drawing = true;
    return;
  }
  if (skState.tool === 'select') {
    // Check if clicking near a resize corner of the selected shape
    if (skState.selected !== null) {
      const s = skState.shapes[skState.selected];
      const corner = skGetResizeCorner(s, p.x, p.y);
      if (corner) {
        skState.resizing = corner;
        skState.dragOrigShape = JSON.parse(JSON.stringify(s));
        skState.dragStart = p;
        skState.drawing = true;
        return;
      }
    }
    // Hit test for move
    let hit = null;
    for (let i = skState.shapes.length-1; i >= 0; i--) {
      if (skHitTest(skState.shapes[i], p.x, p.y)) { hit = i; break; }
    }
    skState.selected = hit;
    skState.resizing = null;
    updateSkDeleteBtn();
    if (hit !== null) {
      skState.dragStart = p;
      skState.dragOrigShape = JSON.parse(JSON.stringify(skState.shapes[hit]));
    }
    skRedraw(); return;
  }
  if (skState.tool === 'pen') { skState.path = [p]; }
}

function skMove(e) {
  // Handle two-finger pinch resize
  if (e.touches && e.touches.length === 2 && skPinch.active) {
    const dist = skPinchDist(e);
    const ratio = dist / skPinch.startDist;
    const orig = skPinch.origShape;
    const s = skState.shapes[skPinch.shapeIdx];
    if (!s || !orig) return;
    // Scale around centre of shape
    const ocx = (orig.x + (orig.x2||orig.x)) / 2;
    const ocy = (orig.y + (orig.y2||orig.y)) / 2;
    const ow = Math.abs((orig.x2||orig.x) - orig.x);
    const oh = Math.abs((orig.y2||orig.y) - orig.y);
    const nw = ow * ratio, nh = oh * ratio;
    s.x = ocx - nw/2; s.y = ocy - nh/2;
    s.x2 = ocx + nw/2; s.y2 = ocy + nh/2;
    skRedraw(); return;
  }

  if (!skState.drawing) return;
  const p = skPos(e);

  // Group drag (lasso move)
  if (skState.tool === 'lasso' && skState.groupDragStart && skState.selectedGroup.length > 0) {
    const dx = p.x - skState.groupDragStart.x;
    const dy = p.y - skState.groupDragStart.y;
    skState.selectedGroup.forEach((idx, gi) => {
      const orig = skState.groupOrigShapes[gi];
      const s = skState.shapes[idx];
      s.x = orig.x + dx; s.y = orig.y + dy;
      if (orig.x2 !== undefined) s.x2 = orig.x2 + dx;
      if (orig.y2 !== undefined) s.y2 = orig.y2 + dy;
      if (orig.path) s.path = orig.path.map(pt => ({x:pt.x+dx, y:pt.y+dy}));
    });
    skRedraw(); return;
  }
  // Lasso draw
  if (skState.tool === 'lasso' && skState.drawing && skState.lasso) {
    skState.lasso.x2 = p.x; skState.lasso.y2 = p.y;
    skRedraw(); return;
  }
  // Resize or drag selected shape
  if (skState.tool === 'select' && skState.selected !== null && skState.dragStart) {
    const dx = p.x - skState.dragStart.x;
    const dy = p.y - skState.dragStart.y;
    const orig = skState.dragOrigShape;
    const s = skState.shapes[skState.selected];
    if (skState.resizing) {
      const c = skState.resizing;
      if (c==='tl') { s.x=orig.x+dx; s.y=orig.y+dy; }
      else if (c==='tr') { s.x2=orig.x2+dx; s.y=orig.y+dy; }
      else if (c==='bl') { s.x=orig.x+dx; s.y2=orig.y2+dy; }
      else if (c==='br') { s.x2=orig.x2+dx; s.y2=orig.y2+dy; }
      else if (c==='t') { s.y=orig.y+dy; }
      else if (c==='b') { s.y2=orig.y2+dy; }
      else if (c==='l') { s.x=orig.x+dx; }
      else if (c==='r') { s.x2=orig.x2+dx; }
    } else {
      s.x = orig.x + dx; s.y = orig.y + dy;
      if (orig.x2 !== undefined) s.x2 = orig.x2 + dx;
      if (orig.y2 !== undefined) s.y2 = orig.y2 + dy;
      if (orig.path) s.path = orig.path.map(pt => ({x:pt.x+dx, y:pt.y+dy}));
    }
    skRedraw(); return;
  }

  if (skState.tool === 'pen') {
    skState.path.push(p);
    skRedraw();
    const c = document.getElementById('sk-main-canvas');
    const ctx = c.getContext('2d');
    skDrawPenPreview(ctx);
    return;
  }
  const drawTools = ['wall','corner','triangle','shelf','hanging','drawer','door-l','door-r'];
  if (drawTools.includes(skState.tool)) {
    skRedraw();
    const c = document.getElementById('sk-main-canvas');
    const ctx = c.getContext('2d');
    skDrawShapePreview(ctx, skState.tool, skState.sx, skState.sy, p.x, p.y);
  }
}

function skUp(e) {
  if (skPinch.active) { skPinch.active = false; skDirty = true; skRedraw(); return; }
  if (!skState.drawing) return;
  // Lasso: on release, select all shapes inside lasso rect
  if (skState.tool === 'lasso' && skState.drawing && skState.lasso) {
    const lx1 = Math.min(skState.lasso.x1, skState.lasso.x2);
    const ly1 = Math.min(skState.lasso.y1, skState.lasso.y2);
    const lx2 = Math.max(skState.lasso.x1, skState.lasso.x2);
    const ly2 = Math.max(skState.lasso.y1, skState.lasso.y2);
    skState.selectedGroup = [];
    skState.shapes.forEach((s, i) => {
      const sx = s.x2!==undefined ? Math.min(s.x,s.x2) : s.x - 60;
      const sy = s.y2!==undefined ? Math.min(s.y,s.y2) : s.y - 10;
      const sx2 = s.x2!==undefined ? Math.max(s.x,s.x2) : s.x + 60;
      const sy2 = s.y2!==undefined ? Math.max(s.y,s.y2) : s.y + 10;
      // Shape is inside lasso if centres overlap or fully contained
      if (sx2 > lx1 && sx < lx2 && sy2 > ly1 && sy < ly2) {
        skState.selectedGroup.push(i);
      }
    });
    skState.lasso = null;
    if (skState.selectedGroup.length > 0) {
      toast(skState.selectedGroup.length + ' shapes selected â€” drag to move group');
    }
    skRedraw();
  }
  skState.drawing = false;
  skState.dragStart = null;
  skState.dragOrigShape = null;
  skState.resizing = null;
  skState.groupDragStart = null;
  const src = e.changedTouches ? e.changedTouches[0] : e;
  const c = document.getElementById('sk-main-canvas');
  const r = c.getBoundingClientRect();
  const sc = c.width / r.width;
  const p = { x: (src.clientX - r.left) * sc, y: (src.clientY - r.top) * sc };
  const dx = Math.abs(p.x - skState.sx), dy = Math.abs(p.y - skState.sy);
  if (skState.tool === 'pen') {
    if (skState.path.length > 1)
      skState.shapes.push({ type:'pen', path:[...skState.path], colour:skState.colour, size:skState.size });
  } else if (['wall','corner','triangle','shelf','hanging','drawer','door-l','door-r'].includes(skState.tool)) {
    if (dx > 8 || dy > 8) {
      skState.shapes.push({ type:skState.tool, x:skState.sx, y:skState.sy, x2:p.x, y2:p.y, colour:skState.colour, size:skState.size });
    }
  }
  skRedraw();
}


function skGetResizeCorner(s, px, py) {
  if (!s || s.x2 === undefined) return null;
  const r = 10; // hit radius
  const x1=s.x, y1=s.y, x2=s.x2, y2=s.y2;
  const mx=(x1+x2)/2, my=(y1+y2)/2;
  if (Math.abs(px-x1)<r && Math.abs(py-y1)<r) return 'tl';
  if (Math.abs(px-x2)<r && Math.abs(py-y1)<r) return 'tr';
  if (Math.abs(px-x1)<r && Math.abs(py-y2)<r) return 'bl';
  if (Math.abs(px-x2)<r && Math.abs(py-y2)<r) return 'br';
  if (Math.abs(px-mx)<r && Math.abs(py-y1)<r) return 't';
  if (Math.abs(px-mx)<r && Math.abs(py-y2)<r) return 'b';
  if (Math.abs(px-x1)<r && Math.abs(py-my)<r) return 'l';
  if (Math.abs(px-x2)<r && Math.abs(py-my)<r) return 'r';
  return null;
}

function skHitTest(s, px, py) {
  const margin = 12;
  const checkRect = (x1,y1,x2,y2) => {
    const x=Math.min(x1,x2), y=Math.min(y1,y2), w=Math.abs(x2-x1), h=Math.abs(y2-y1);
    return px>=x-margin && px<=x+w+margin && py>=y-margin && py<=y+h+margin;
  };
  if (['wall','corner','door-l','door-r','drawer','triangle'].includes(s.type)) return checkRect(s.x,s.y,s.x2,s.y2);
  if (s.type==='shelf'||s.type==='hanging') {
    return Math.abs(py - (s.y+s.y2)/2) < margin+4 && px>=Math.min(s.x,s.x2)-margin && px<=Math.max(s.x,s.x2)+margin;
  }
  if (s.type==='text') { return Math.abs(px-s.x)<160 && Math.abs(py-s.y)<24; }
  return false;
}

// â”€â”€ Presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skInsertPreset(type) {
  const W = skState.canvasW, H = skState.canvasH;
  const cx = W/2, col = skState.colour;
  const shapes = [];
  const ceil = H*0.06, floor = H*0.94;
  const fullH = floor - ceil;

  // Helper: single wardrobe unit with top box, main body, doors, hanging rail
  // bx=left edge, uw=width, mainH=main body height, topBoxH=top box height
  function addUnit(bx, uw, mainH, topBoxH, doorStyle, label) {
    const uy = ceil + topBoxH; // top of main body
    // Top box
    if (topBoxH > 2) {
      shapes.push({type:'wall', x:bx, y:ceil, x2:bx+uw, y2:ceil+topBoxH, colour:col, size:2});
      if (uw > 60) {
        shapes.push({type:'door-l', x:bx+3, y:ceil+3, x2:bx+uw/2-1, y2:ceil+topBoxH-3, colour:col, size:1});
        shapes.push({type:'door-r', x:bx+uw/2+1, y:ceil+3, x2:bx+uw-3, y2:ceil+topBoxH-3, colour:col, size:1});
      }
    }
    // Main body
    shapes.push({type:'wall', x:bx, y:uy, x2:bx+uw, y2:uy+mainH, colour:col, size:2});
    // Doors on main body
    if (doorStyle === 'single') {
      shapes.push({type:'door-l', x:bx+3, y:uy+3, x2:bx+uw-3, y2:uy+mainH-3, colour:col, size:1});
    } else {
      shapes.push({type:'door-l', x:bx+3, y:uy+3, x2:bx+uw/2-1, y2:uy+mainH-3, colour:col, size:1});
      shapes.push({type:'door-r', x:bx+uw/2+1, y:uy+3, x2:bx+uw-3, y2:uy+mainH-3, colour:col, size:1});
    }
    // Hanging rail inside at ~25% down
    shapes.push({type:'hanging', x:bx+8, y:uy+mainH*0.25, x2:bx+uw-8, y2:uy+mainH*0.25, colour:col, size:2});
    // â”€â”€ Dimension labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Width  â†’ centred at the very bottom of the unit
    // Depth  â†’ just below Width
    // Height â†’ right side of unit, vertically centred
    const wLabelX = bx + uw * 0.5 - 44;       // bottom-centre of unit
    const wLabelY = uy + mainH + 16;            // just below the unit floor line
    const hLabelX = bx + uw + 8;               // right of unit
    const hLabelY = uy + mainH * 0.5;           // vertical centre of unit
    shapes.push({type:'text', x:wLabelX,     y:wLabelY,      text:'Width: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:wLabelX,     y:wLabelY + 18, text:'Depth: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:hLabelX,     y:hLabelY,      text:'Height: _______ mm', colour:'#c0392b', size:0, isDim:true});
    // Unit label below the depth label, clearly separated
    if (label) shapes.push({type:'text', x:bx + uw*0.25, y:wLabelY + 38, text:label, colour:col, size:1});
  }

  if (type === 'single-wardrobe') {
    const uw=W*0.32, topBoxH=fullH*0.18, mainH=fullH*0.82;
    addUnit(cx-uw/2, uw, mainH, topBoxH, 'double', 'Single Wardrobe');

  } else if (type === 'double-wardrobe') {
    const uw=W*0.28, topBoxH=fullH*0.18, mainH=fullH*0.82;
    addUnit(cx-uw-4, uw, mainH, topBoxH, 'double', '');
    addUnit(cx+4, uw, mainH, topBoxH, 'double', '');
    shapes.push({type:'text', x:cx-30, y:floor+16, text:'Double Wardrobe', colour:col, size:1});

  } else if (type === 'triple-wardrobe') {
    const uw=W*0.22, topBoxH=fullH*0.18, mainH=fullH*0.82;
    addUnit(cx-uw*1.5-4, uw, mainH, topBoxH, 'double', '');
    addUnit(cx-uw/2, uw, mainH, topBoxH, 'double', '');
    addUnit(cx+uw/2+4, uw, mainH, topBoxH, 'double', '');
    shapes.push({type:'text', x:cx-40, y:floor+16, text:'Triple Wardrobe', colour:col, size:1});

  } else if (type === 'top-box') {
    // Standalone top box with size labels
    const uw=W*0.28, tbH=fullH*0.2, bx=cx-uw/2;
    shapes.push({type:'wall', x:bx, y:ceil, x2:bx+uw, y2:ceil+tbH, colour:col, size:2});
    shapes.push({type:'door-l', x:bx+3, y:ceil+3, x2:bx+uw/2-1, y2:ceil+tbH-3, colour:col, size:1});
    shapes.push({type:'door-r', x:bx+uw/2+1, y:ceil+3, x2:bx+uw-3, y2:ceil+tbH-3, colour:col, size:1});
    // Dims inside top box
    shapes.push({type:'text', x:bx+6, y:ceil+tbH-36, text:'W: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:bx+6, y:ceil+tbH-20, text:'H: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:bx+6, y:ceil+tbH- 4, text:'D: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:bx+4, y:ceil+tbH+18, text:'Top Box', colour:col, size:1});

  } else if (type === 'corner-unit') {
    // Front view: left hanging section + right shelf tower, meeting in the centre
    // Both floor-to-ceiling, top boxes included â€” proper front elevation
    const lw=W*0.36, rw=W*0.28, topH=fullH*0.18, mainH=fullH*0.82;
    const lx=cx-lw-2, rx=cx+2;
    // â”€â”€ Left wardrobe (hanging, with top box) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    shapes.push({type:'wall', x:lx, y:ceil, x2:lx+lw, y2:ceil+topH, colour:col, size:2});
    shapes.push({type:'door-l', x:lx+3, y:ceil+3, x2:lx+lw/2-1, y2:ceil+topH-3, colour:col, size:1});
    shapes.push({type:'door-r', x:lx+lw/2+1, y:ceil+3, x2:lx+lw-3, y2:ceil+topH-3, colour:col, size:1});
    shapes.push({type:'wall', x:lx, y:ceil+topH, x2:lx+lw, y2:ceil+topH+mainH, colour:col, size:2});
    shapes.push({type:'door-l', x:lx+3, y:ceil+topH+3, x2:lx+lw/2-1, y2:ceil+topH+mainH-3, colour:col, size:1});
    shapes.push({type:'door-r', x:lx+lw/2+1, y:ceil+topH+3, x2:lx+lw-3, y2:ceil+topH+mainH-3, colour:col, size:1});
    shapes.push({type:'hanging', x:lx+8, y:ceil+topH+mainH*0.28, x2:lx+lw-8, y2:ceil+topH+mainH*0.28, colour:col, size:2});
    // â”€â”€ Right shelf tower (with top box + shelves) â”€â”€â”€â”€â”€â”€
    shapes.push({type:'wall', x:rx, y:ceil, x2:rx+rw, y2:ceil+topH, colour:col, size:2});
    shapes.push({type:'door-l', x:rx+3, y:ceil+3, x2:rx+rw-3, y2:ceil+topH-3, colour:col, size:1});
    shapes.push({type:'wall', x:rx, y:ceil+topH, x2:rx+rw, y2:ceil+topH+mainH, colour:col, size:2});
    shapes.push({type:'door-l', x:rx+3, y:ceil+topH+3, x2:rx+rw-3, y2:ceil+topH+mainH-3, colour:col, size:1});
    for (let i=1;i<=4;i++) shapes.push({type:'shelf', x:rx+6, y:ceil+topH+mainH*(i/5), x2:rx+rw-6, y2:ceil+topH+mainH*(i/5), colour:col, size:1.5});
    // â”€â”€ Dimension labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const totalW = lw + rw + 4;
    shapes.push({type:'text', x:lx + totalW*0.3, y:ceil+topH+mainH+16, text:'Width: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:lx + totalW*0.3, y:ceil+topH+mainH+34, text:'Depth: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:rx+rw+6, y:ceil+topH+mainH*0.5, text:'Height: _______ mm', colour:'#c0392b', size:0, isDim:true});
    shapes.push({type:'text', x:cx-45, y:ceil+topH+mainH+52, text:'Corner Wardrobe (Front View)', colour:col, size:1});

  } else if (type === 'tall-shelf') {
    const uw=W*0.24, uh=fullH*0.92, bx=cx-uw/2;
    shapes.push({type:'wall', x:bx, y:ceil, x2:bx+uw, y2:ceil+uh, colour:col, size:2});
    for (let i=1;i<=5;i++) shapes.push({type:'shelf', x:bx+6, y:ceil+uh*(i/6), x2:bx+uw-6, y2:ceil+uh*(i/6), colour:col, size:1.5});
    shapes.push({type:'text', x:bx, y:ceil+uh+16, text:'Shelf Tower', colour:col, size:1});

  } else if (type === 'single-drawer') {
    // One single drawer face â€” drag to place more
    const uw=W*0.28, dh=H*0.09, bx=cx-uw/2, by=H*0.42;
    shapes.push({type:'drawer', x:bx, y:by, x2:bx+uw, y2:by+dh, colour:col, size:2});
    shapes.push({type:'text', x:bx+4, y:by+dh+13, text:'Drawer â€” add more below', colour:col, size:0});

  } else if (type === 'dressing-desk') {
    // Desk with 3 drawers on right side and large mirror above
    const dw=W*0.52, dh=fullH*0.45, top=H*0.45, bx=cx-dw/2;
    const drawerW=dw*0.28, legW=dw*0.06;
    // Desktop surface
    shapes.push({type:'wall', x:bx, y:top, x2:bx+dw, y2:top+dh*0.08, colour:col, size:2});
    // Left leg/panel
    shapes.push({type:'wall', x:bx, y:top+dh*0.08, x2:bx+legW, y2:top+dh, colour:col, size:1.5});
    // Right drawer stack (3 drawers)
    const dx = bx+dw-drawerW;
    shapes.push({type:'wall', x:dx, y:top+dh*0.08, x2:bx+dw, y2:top+dh, colour:col, size:1.5});
    const drawH = (dh*0.88)/3;
    for (let i=0;i<3;i++) {
      const dy = top+dh*0.1 + i*drawH;
      shapes.push({type:'drawer', x:dx+3, y:dy+2, x2:bx+dw-3, y2:dy+drawH-2, colour:col, size:1.5});
    }
    // Centre open knee space
    shapes.push({type:'text', x:bx+dw*0.25, y:top+dh*0.55, text:'Knee Space', colour:col, size:0});
    // Mirror above
    const mw=dw*0.55, mh=fullH*0.38;
    shapes.push({type:'wall', x:cx-mw/2, y:top-mh-8, x2:cx+mw/2, y2:top-8, colour:col, size:1.5});
    // Mirror cross lines to indicate glass
    shapes.push({type:'text', x:cx-18, y:top-mh/2, text:'Mirror', colour:col, size:1});
    shapes.push({type:'text', x:bx+4, y:top+dh+16, text:'Dressing Desk with Mirror', colour:col, size:1});
  }
  skState.shapes.push(...shapes);
  skRedraw();
  skDirty = true;
}

// â”€â”€ Drawing functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skDrawShapePreview(ctx, tool, x1, y1, x2, y2) {
  ctx.save();
  ctx.setLineDash([6,4]);
  skRenderShape(ctx, {type:tool, x:x1, y:y1, x2:x2, y2:y2, colour:skState.colour, size:skState.size}, true);
  ctx.restore();
}

function skDrawPenPreview(ctx) {
  if (skState.path.length < 2) return;
  ctx.beginPath();
  ctx.moveTo(skState.path[0].x, skState.path[0].y);
  skState.path.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = skState.colour;
  ctx.lineWidth = skState.size;
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  ctx.stroke();
}

function skRenderShape(ctx, s, preview) {
  const x1=s.x, y1=s.y, x2=s.x2!==undefined?s.x2:s.x, y2=s.y2!==undefined?s.y2:s.y;
  const minX=Math.min(x1,x2), minY=Math.min(y1,y2);
  const w=Math.abs(x2-x1), h=Math.abs(y2-y1);
  ctx.strokeStyle = s.colour || '#1a1a1a';
  ctx.fillStyle = s.colour || '#1a1a1a';
  ctx.lineWidth = s.size || 2;
  ctx.lineCap = 'square'; ctx.lineJoin = 'miter';

  if (s.type === 'wall') {
    ctx.fillStyle = 'rgba(240,235,228,0.65)';
    ctx.fillRect(minX, minY, w, h);
    ctx.strokeStyle = s.colour; ctx.lineWidth = s.size;
    ctx.strokeRect(minX, minY, w, h);
    ctx.strokeStyle = 'rgba(0,0,0,0.07)'; ctx.lineWidth = 1;
    ctx.strokeRect(minX+3, minY+3, w-6, h-6);

  } else if (s.type === 'corner') {
    const cx2=minX+w*0.5, cy2=minY+h*0.5;
    ctx.fillStyle = 'rgba(240,235,228,0.65)';
    ctx.beginPath();
    ctx.moveTo(minX,minY); ctx.lineTo(minX+w,minY);
    ctx.lineTo(minX+w,cy2); ctx.lineTo(cx2,cy2);
    ctx.lineTo(cx2,minY+h); ctx.lineTo(minX,minY+h);
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle=s.colour; ctx.lineWidth=s.size; ctx.stroke();
    ctx.fillStyle=s.colour; ctx.font='bold 11px Arial';
    ctx.fillText('Corner', minX+6, minY+18);

  } else if (s.type === 'triangle') {
    // Angled/dormer shape â€” right triangle for sloped ceiling
    ctx.fillStyle = 'rgba(240,235,228,0.65)';
    ctx.beginPath();
    ctx.moveTo(minX, minY+h);   // bottom-left
    ctx.lineTo(minX+w, minY+h); // bottom-right
    ctx.lineTo(minX+w, minY);   // top-right (tall side)
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle=s.colour; ctx.lineWidth=s.size; ctx.stroke();
    ctx.fillStyle=s.colour; ctx.font='10px Arial';
    ctx.fillText('Angled', minX+8, minY+h-12);

  } else if (s.type === 'door-l') {
    // Left-hand door: handle on right edge, hinge on left
    ctx.fillStyle = 'rgba(220,210,195,0.4)';
    ctx.fillRect(minX, minY, w, h);
    ctx.strokeStyle = s.colour; ctx.lineWidth = s.size*0.8;
    ctx.strokeRect(minX, minY, w, h);
    // Hinge marks left side
    ctx.fillStyle = s.colour;
    ctx.fillRect(minX+1, minY+h*0.2-3, 5, 6);
    ctx.fillRect(minX+1, minY+h*0.8-3, 5, 6);
    // Handle on right (suppressed for sliding doors)
    if (!skState.isSliding && !s.noHandle) {
      const hy = minY+h/2;
      ctx.beginPath(); ctx.moveTo(minX+w-10, hy-9); ctx.lineTo(minX+w-10, hy+9);
      ctx.lineWidth=s.size+1; ctx.strokeStyle=s.colour; ctx.lineCap='round'; ctx.stroke();
    }
    // Grain lines
    ctx.strokeStyle='rgba(0,0,0,0.05)'; ctx.lineWidth=0.8; ctx.lineCap='square';
    for (let yy=minY+14;yy<minY+h-8;yy+=16){ctx.beginPath();ctx.moveTo(minX+8,yy);ctx.lineTo(minX+w-8,yy);ctx.stroke();}
    ctx.fillStyle=s.colour; ctx.font='bold 10px Arial';
    if (skState.isSliding) {
      ctx.fillText('Sliding', minX+4, minY+14);
      // Sliding door track lines at top and bottom
      ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.lineWidth=2; ctx.setLineDash([]);
      ctx.beginPath(); ctx.moveTo(minX,minY+3); ctx.lineTo(minX+w,minY+3); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(minX,minY+h-3); ctx.lineTo(minX+w,minY+h-3); ctx.stroke();
    } else {
      ctx.fillText('L', minX+4, minY+12);
    }

  } else if (s.type === 'door-r') {
    // Right-hand door: handle on left edge, hinge on right
    ctx.fillStyle = 'rgba(220,210,195,0.4)';
    ctx.fillRect(minX, minY, w, h);
    ctx.strokeStyle = s.colour; ctx.lineWidth = s.size*0.8;
    ctx.strokeRect(minX, minY, w, h);
    // Hinge marks right side
    ctx.fillStyle = s.colour;
    ctx.fillRect(minX+w-6, minY+h*0.2-3, 5, 6);
    ctx.fillRect(minX+w-6, minY+h*0.8-3, 5, 6);
    // Handle on left (suppressed for sliding doors)
    if (!skState.isSliding && !s.noHandle) {
      const hy = minY+h/2;
      ctx.beginPath(); ctx.moveTo(minX+10, hy-9); ctx.lineTo(minX+10, hy+9);
      ctx.lineWidth=s.size+1; ctx.strokeStyle=s.colour; ctx.lineCap='round'; ctx.stroke();
    }
    // Grain lines
    ctx.strokeStyle='rgba(0,0,0,0.05)'; ctx.lineWidth=0.8; ctx.lineCap='square';
    for (let yy=minY+14;yy<minY+h-8;yy+=16){ctx.beginPath();ctx.moveTo(minX+8,yy);ctx.lineTo(minX+w-8,yy);ctx.stroke();}
    ctx.fillStyle=s.colour; ctx.font='bold 10px Arial';
    if (skState.isSliding) {
      ctx.fillText('Sliding', minX+4, minY+14);
      ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.lineWidth=2; ctx.setLineDash([]);
      ctx.beginPath(); ctx.moveTo(minX,minY+3); ctx.lineTo(minX+w,minY+3); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(minX,minY+h-3); ctx.lineTo(minX+w,minY+h-3); ctx.stroke();
    } else {
      ctx.fillText('R', minX+w-12, minY+12);
    }

  } else if (s.type === 'shelf') {
    const sy=(y1+y2)/2;
    ctx.strokeStyle=s.colour; ctx.lineWidth=s.size+1;
    ctx.beginPath(); ctx.moveTo(minX,sy); ctx.lineTo(minX+w,sy); ctx.stroke();
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(minX,sy+2); ctx.lineTo(minX+w,sy+2); ctx.stroke();

  } else if (s.type === 'hanging') {
    const ry=(y1+y2)/2;
    ctx.strokeStyle=s.colour; ctx.lineWidth=s.size;
    ctx.beginPath(); ctx.moveTo(minX,ry); ctx.lineTo(minX+w,ry); ctx.stroke();
    const spacing=Math.max(22,w/Math.max(1,Math.floor(w/26)));
    ctx.strokeStyle=s.colour; ctx.lineWidth=1.5;
    for (let hx=minX+spacing/2;hx<minX+w-8;hx+=spacing){
      ctx.beginPath(); ctx.arc(hx,ry,3,Math.PI,0); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(hx-9,ry+7); ctx.lineTo(hx,ry+3); ctx.lineTo(hx+9,ry+7); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(hx-9,ry+7); ctx.lineTo(hx-9,ry+24); ctx.lineTo(hx+9,ry+24); ctx.lineTo(hx+9,ry+7); ctx.stroke();
    }
    ctx.fillStyle=s.colour; ctx.font='bold 11px Arial';
    ctx.fillText('Rail',minX+4,ry-5);

  } else if (s.type === 'drawer') {
    ctx.fillStyle='rgba(200,190,178,0.55)';
    ctx.fillRect(minX,minY,w,h);
    ctx.strokeStyle=s.colour; ctx.lineWidth=s.size*0.8;
    ctx.strokeRect(minX,minY,w,h);
    // Central handle bar
    const hW=Math.min(w*0.38,55);
    ctx.beginPath();
    ctx.moveTo(minX+w/2-hW/2, minY+h/2);
    ctx.lineTo(minX+w/2+hW/2, minY+h/2);
    ctx.lineWidth=s.size+1; ctx.strokeStyle=s.colour; ctx.lineCap='round'; ctx.stroke();

  } else if (s.type === 'pen') {
    if (!s.path||s.path.length<2) return;
    ctx.beginPath(); ctx.moveTo(s.path[0].x,s.path[0].y);
    s.path.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.strokeStyle=s.colour; ctx.lineWidth=s.size;
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.stroke();

  } else if (s.type === 'text') {
    const isDim = s.isDim || (s.size||0) === 0;
    // Dimension labels: large, red, bold â€” regular labels: normal bold
    const sz = isDim ? 13 : (13 + (s.size||0)*4);
    ctx.font = 'bold ' + sz + 'px Arial';
    ctx.fillStyle = s.colour || '#1a1a1a';
    ctx.fillText(s.text, s.x, s.y);
    // Underline + pencil icon on dimension labels
    if (isDim) {
      const tw = ctx.measureText(s.text).width;
      ctx.strokeStyle = s.colour || '#c0392b';
      ctx.lineWidth = 1.5;
      ctx.setLineDash([4, 2]);
      ctx.beginPath(); ctx.moveTo(s.x, s.y + 3); ctx.lineTo(s.x + tw, s.y + 3); ctx.stroke();
      ctx.setLineDash([]);
      // âœ pencil icon â€” signals double-click to edit
      ctx.font = 'bold 11px Arial';
      ctx.fillStyle = 'rgba(192,57,43,0.8)';
      ctx.fillText(' âœ', s.x + tw, s.y);
      ctx.font = 'bold ' + sz + 'px Arial';
    }
  }
}

function skRedraw() {
  const c = document.getElementById('sk-main-canvas');
  if (!c) return;
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#faf9f7';
  ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#e8e5e0'; ctx.lineWidth=0.5;
  for (let x=0;x<W;x+=30){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for (let y=0;y<H;y+=30){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // Ceiling/floor guides
  ctx.strokeStyle='#c0392b'; ctx.lineWidth=1; ctx.setLineDash([6,4]);
  const floor=H*0.94, ceil=H*0.06;
  ctx.beginPath();ctx.moveTo(0,floor);ctx.lineTo(W,floor);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,ceil);ctx.lineTo(W,ceil);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='rgba(192,57,43,0.85)'; ctx.font='bold 13px Arial';
  ctx.fillText('CEILING',6,ceil-3);
  ctx.fillText('FLOOR',6,floor+14);
  // Shapes
  skState.shapes.forEach((s,i)=>{
    ctx.save();
    skRenderShape(ctx,s,false);
    if (skState.selected===i && s.x2!==undefined){
      const x1=s.x,y1=s.y,x2=s.x2,y2=s.y2;
      const bx=Math.min(x1,x2)-6, by=Math.min(y1,y2)-6;
      const bw=Math.abs(x2-x1)+12, bh=Math.abs(y2-y1)+12;
      ctx.setLineDash([4,4]); ctx.strokeStyle='#2980b9'; ctx.lineWidth=1.5;
      ctx.strokeRect(bx,by,bw,bh);
      ctx.setLineDash([]);
      // 8 resize handles: corners + edge midpoints
      const mx=(x1+x2)/2, my=(y1+y2)/2;
      [[x1,y1],[x2,y1],[x1,y2],[x2,y2],[mx,y1],[mx,y2],[x1,my],[x2,my]].forEach(([hx,hy])=>{
        ctx.fillStyle='#2980b9';
        ctx.fillRect(hx-5,hy-5,10,10);
        ctx.strokeStyle='#fff'; ctx.lineWidth=1.5;
        ctx.strokeRect(hx-5,hy-5,10,10);
      });
      ctx.fillStyle='rgba(41,128,185,0.9)'; ctx.font='bold 9px Arial';
      ctx.fillText('drag=move  drag handle=resize  pinch=scale',bx,by-6);
    }
    ctx.restore();
  });
  // Watermark
  ctx.fillStyle='rgba(192,57,43,0.06)';
  ctx.font='bold 12px Arial';
  ctx.fillText('LUXURY HOUSE  |  luxuryhouseonline.com',W/2-130,H-5);
  // Lasso rect
  if (skState.lasso) {
    const l = skState.lasso;
    ctx.setLineDash([4,3]); ctx.strokeStyle='#27ae60'; ctx.lineWidth=1.5;
    ctx.fillStyle='rgba(39,174,96,0.05)';
    const lx=Math.min(l.x1,l.x2), ly=Math.min(l.y1,l.y2);
    const lw=Math.abs(l.x2-l.x1), lh=Math.abs(l.y2-l.y1);
    ctx.fillRect(lx,ly,lw,lh);
    ctx.strokeRect(lx,ly,lw,lh);
    ctx.setLineDash([]);
  }
  // Group selection highlight
  if (skState.selectedGroup.length > 0) {
    let gx1=Infinity,gy1=Infinity,gx2=-Infinity,gy2=-Infinity;
    skState.selectedGroup.forEach(i => {
      const s = skState.shapes[i];
      const sx1=s.x2!==undefined?Math.min(s.x,s.x2):s.x-40, sy1=s.y2!==undefined?Math.min(s.y,s.y2):s.y-10;
      const sx2=s.x2!==undefined?Math.max(s.x,s.x2):s.x+40, sy2=s.y2!==undefined?Math.max(s.y,s.y2):s.y+10;
      gx1=Math.min(gx1,sx1); gy1=Math.min(gy1,sy1); gx2=Math.max(gx2,sx2); gy2=Math.max(gy2,sy2);
    });
    ctx.setLineDash([5,3]); ctx.strokeStyle='#27ae60'; ctx.lineWidth=2;
    ctx.fillStyle='rgba(39,174,96,0.04)';
    ctx.fillRect(gx1-4,gy1-4,gx2-gx1+8,gy2-gy1+8);
    ctx.strokeRect(gx1-4,gy1-4,gx2-gx1+8,gy2-gy1+8);
    ctx.setLineDash([]);
    ctx.fillStyle='rgba(39,174,96,0.9)'; ctx.font='bold 10px Arial';
    ctx.fillText('â¬š '+skState.selectedGroup.length+' shapes â€” drag to move',gx1,gy1-7);
  }
}


function skDblClick(e) {
  const p = skPos(e);
  // Search from top shape down â€” find nearest text shape
  for (let i = skState.shapes.length - 1; i >= 0; i--) {
    const s = skState.shapes[i];
    if (s.type === 'text') {
      // Generous hit zone: 240px wide, 28px tall
      if (Math.abs(p.x - s.x) < 240 && Math.abs(p.y - s.y) < 28) {
        const label = s.isDim || (s.size||0) === 0 ? 'Enter measurement (e.g. 2400mm or just 2400):' : 'Edit label:';
        const newText = prompt(label, s.text);
        if (newText !== null && newText.trim() !== '') {
          // If user typed just a number, format it nicely
          const raw = newText.trim();
          const isJustNum = /^[\d.]+$/.test(raw);
          const prefix = s.text.match(/^[WHD]:/);
          if (isJustNum && prefix) {
            s.text = prefix[0] + ' ' + raw + ' mm';
          } else {
            s.text = raw;
          }
          skRedraw(); skDirty = true;
        }
        return;
      }
    }
  }
}

function skSelectAll() {
  skSetTool('lasso');
  skState.selectedGroup = skState.shapes.map((_,i) => i);
  if (skState.selectedGroup.length > 0) {
    skState.groupOrigShapes = skState.shapes.map(s => JSON.parse(JSON.stringify(s)));
    toast('All '+skState.selectedGroup.length+' shapes selected â€” drag to move');
    skRedraw();
  } else { toast('No shapes to select'); }
}

function skUndo() {
  if (skState.shapes.length > 0) { skState.shapes.pop(); skState.selected = null; skRedraw(); updateSkDeleteBtn(); }
}
function skClear() {
  if (!confirm('Clear the entire design?')) return;
  skState.shapes = []; skState.selected = null; skRedraw(); updateSkDeleteBtn();
}
function skDeleteSelected() {
  if (skState.selected === null) return;
  skState.shapes.splice(skState.selected, 1);
  skState.selected = null;
  skRedraw(); updateSkDeleteBtn(); skDirty = true;
}
function skKeyDown(e) {
  if (e.key === 'Delete' || e.key === 'Backspace') {
    if (skState.selected !== null) { e.preventDefault(); skDeleteSelected(); }
  }
  if ((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); skUndo(); }
}
function updateSkDeleteBtn() {
  const btn = document.getElementById('sk-delete-btn');
  if (btn) btn.style.display = skState.selected !== null ? 'block' : 'none';
}

function getSketchPNG(id) {
  const item = getItem(id);
  if (!item) return null;
  // Try PNG snapshot first (from designer)
  if (item.sketchPNG) return item.sketchPNG;
  // Legacy
  if (item.sketchHistory && item.sketchHistory.length) {
    const h = item.sketchHistory[0];
    if (h && h.type === 'png') return h.data;
  }
  return null;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNATURE CANVASES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSigCanvases() {
  ['sig-customer','sig-agent'].forEach(id => {
    const c = document.getElementById(id);
    if (!c || c._siginit) return;
    c._siginit = true;
    c.width = c.parentElement.clientWidth || 300;
    let drawing = false;
    const getPos = e => {
      const r=c.getBoundingClientRect();
      const src=e.touches?e.touches[0]:e;
      return {x:src.clientX-r.left,y:src.clientY-r.top};
    };
    const start = e => { drawing=true; const p=getPos(e); const ctx=c.getContext('2d'); ctx.beginPath(); ctx.moveTo(p.x,p.y); };
    const move = e => { if(!drawing)return; e.preventDefault(); const p=getPos(e); const ctx=c.getContext('2d'); ctx.lineTo(p.x,p.y); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke(); };
    const end = () => drawing=false;
    c.addEventListener('mousedown',start); c.addEventListener('touchstart',start,{passive:true});
    c.addEventListener('mousemove',move); c.addEventListener('touchmove',move,{passive:false});
    c.addEventListener('mouseup',end); c.addEventListener('touchend',end);
  });
}

function clearSig(id) {
  const c=document.getElementById(id);
  if(c){const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEPPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goStep(n) {
  if (n > currentStep && !validateStep(currentStep)) return;
  document.querySelectorAll('.quote-section').forEach(s=>s.classList.remove('active'));
  document.getElementById('qs-'+n).classList.add('active');
  for (let i=1;i<=4;i++) {
    const el=document.getElementById('si-'+i);
    el.className='step'+(i<n?' done':i===n?' active':'');
    el.querySelector('.step-num').textContent=i<n?'âœ“':i;
  }
  currentStep=n;
  if (n===2 && items.length===0) addItem();
  if (n===3) {
    updateGrandTotal();
    setTimeout(initSigCanvases,120);
    // Auto-populate install date to ~4 weeks from today if not already set
    const installEl = document.getElementById('install-date');
    if (installEl && !installEl.value) {
      const d = new Date();
      d.setDate(d.getDate() + 28);
      installEl.value = d.toISOString().split('T')[0];
    }
    // Auto-populate today's date for signatures
    const sigDateEl = document.getElementById('sig-customer-date');
    if (sigDateEl && !sigDateEl.value) {
      sigDateEl.value = new Date().toISOString().split('T')[0];
    }
  }
  if (n===4) { document.getElementById('final-preview').innerHTML=buildQuoteHTML(collectData()); }
  window.scrollTo({top:0,behavior:'smooth'});
}

function validateStep(n) {
  if (n===1) {
    if (!document.getElementById('c-first')?.value.trim() || !document.getElementById('c-phone')?.value.trim() || !document.getElementById('c-address')?.value.trim()) {
      toast('Please enter customer First Name, Phone and Address'); return false;
    }
  }
  if (n===2) {
    for (const item of items) {
      if (!item.w) { toast('Item '+(items.indexOf(item)+1)+': Please enter the width'); return false; }
    }
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLECT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function collectData() {
  const g = calcGrand();
  const actual = parseInt(document.getElementById('deposit-actual')?.value) || g.rec;
  return {
    id: 'LH-' + Date.now().toString().slice(-6),
    date: new Date().toLocaleDateString('en-GB'),
    customer: {
      name: `${document.getElementById('c-first').value} ${document.getElementById('c-last').value}`,
      email: document.getElementById('c-email').value,
      phone: document.getElementById('c-phone').value,
      address: document.getElementById('c-address').value,
    },
    surveyor: document.getElementById('c-surveyor').value,
    internalNotes: document.getElementById('c-notes').value,
    items: items.map(item => ({
      ...item,
      sketchPNG: getSketchPNG(item.id),
      basePrice: calcItemPrice(item),
    })),
    pricing: { total: g.total, rec: g.rec, disc: g.disc },
    depositActual: actual,
    paymentMethod: document.getElementById('payment-method').value,
    leadTime: document.getElementById('lead-time').value,
    installDate: document.getElementById('install-date').value,
    sigCustomerPNG: (function(){ const c=document.getElementById('sig-customer'); return c?c.toDataURL():null; }()),
    sigAgentPNG: (function(){ const c=document.getElementById('sig-agent'); return c?c.toDataURL():null; }()),
    sigCustomerName: document.getElementById('sig-customer-name').value,
    sigCustomerDate: (function(){ const d=document.getElementById('sig-customer-date') && document.getElementById('sig-customer-date').value; if(!d)return ''; const p=d.split('-'); return p[2]+'/'+p[1]+'/'+p[0]; }()),
    sigAgentName: document.getElementById('sig-agent-name').value,
    status: (document.getElementById('dep-actual')&&parseFloat(document.getElementById('dep-actual').value)>0)?'Deposit Taken':'Quoted',
    notes: [],
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD QUOTE HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildQuoteHTML(q) {
  var bal = Math.max(0, q.pricing.total - q.depositActual);
  var colFn = function(item) { return item.customColour || (item.colour ? item.colour.code + ' ' + item.colour.name + ' (' + item.colour.brand + ')' : 'â€”'); };

  var itemsHTML = (q.items||[]).map(function(item, idx) {
    var vat = Math.round(item.basePrice * 0.2);
    var tot = item.basePrice + vat;
    var col = colFn(item);
    var addonLine = '';
    if (item.addons && item.addons.length) {
      addonLine = '<div class="qp-row"><span>Accessories</span><span>' + item.addons.join(', ') + (item.customAddon ? ', ' + item.customAddon : '') + '</span></div>';
    } else if (item.customAddon) {
      addonLine = '<div class="qp-row"><span>Accessories</span><span>' + item.customAddon + '</span></div>';
    }
    var notesLine = item.bespokeNotes ? '<div class="qp-row"><span>Special Notes</span><span>' + item.bespokeNotes + '</span></div>' : '';
    var extraLine = item.extraPrice ? '<div class="qp-row"><span>Additional Works</span><span>\u00a3' + parseFloat(item.extraPrice).toLocaleString() + '</span></div>' : '';
    var sketchLine = item.sketchPNG ? '<div style="margin-top:12px"><div style="font-size:10px;color:#888;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px">Design Sketch</div><img src="' + item.sketchPNG + '" style="width:100%;border:1px solid #eee;border-radius:6px"></div>' : '';
    return '<div class="qp-item-box">' +
      '<div class="qp-item-title">Item ' + (idx+1) + ' \u2014 ' + item.room + ' (' + item.type + ')</div>' +
      '<div class="qp-row"><span>Configuration</span><span>' + item.doors + '</span></div>' +
      '<div class="qp-row"><span>Dimensions</span><span>' + item.w + 'mm W \u00d7 ' + item.h + 'mm H \u00d7 ' + item.d + 'mm D \u00d7 ' + item.units + ' unit' + (item.units>1?'s':'') + '</span></div>' +
      '<div class="qp-row"><span>Door Style</span><span>' + item.doorStyle + ' \u2014 ' + item.finish + '</span></div>' +
      '<div class="qp-row"><span>Board Colour</span><span>' + col + '</span></div>' +
      '<div class="qp-row"><span>Handles</span><span>' + item.handles + '</span></div>' +
      '<div class="qp-row"><span>Interior</span><span>' + item.rails + ', ' + item.shelves + ' Shelves, ' + item.drawers + '</span></div>' +
      '<div class="qp-row"><span>Interior Colour</span><span>' + item.interiorFinish + '</span></div>' +
      addonLine + notesLine + extraLine +
      '<div style="margin-top:10px;padding-top:8px;border-top:1px solid #eee">' +
        '<div class="qp-row"><span>Sub-total (ex. VAT)</span><span>\u00a3' + item.basePrice.toLocaleString() + '</span></div>' +
        '<div class="qp-row"><span>VAT (20%)</span><span>\u00a3' + vat.toLocaleString() + '</span></div>' +
        '<div class="qp-row" style="font-weight:bold"><span>Item Total (inc. VAT)</span><span style="color:#c0392b">\u00a3' + tot.toLocaleString() + '</span></div>' +
      '</div>' +
      sketchLine +
      '</div>';
  }).join('');

  var surveyorLine = q.surveyor ? '<div style="font-size:11px;color:#555">Agent: ' + q.surveyor + '</div>' : '';
  var discLine = q.pricing.disc ? '<div class="qp-row"><span>Discount Applied</span><span>\u2212\u00a3' + q.pricing.disc.toLocaleString() + '</span></div>' : '';
  var installLine = q.installDate ? '<div class="qp-row"><span>Expected Install Date</span><span>' + q.installDate + '</span></div>' : '';
  var sigCustImg = q.sigCustomerPNG ? '<img src="' + q.sigCustomerPNG + '" style="width:100%;max-height:80px;object-fit:contain;border:1px solid #eee;border-radius:4px">' : '<div style="height:60px;border:1px dashed #ccc;border-radius:4px"></div>';
  var sigAgentImg = q.sigAgentPNG ? '<img src="' + q.sigAgentPNG + '" style="width:100%;max-height:80px;object-fit:contain;border:1px solid #eee;border-radius:4px">' : '<div style="height:60px;border:1px dashed #ccc;border-radius:4px"></div>';

  return '<div class="qp">' +
    '<div class="qp-header">' +
      '<div><div class="qp-logo">LUXURY HOUSE</div>' +
        '<div style="font-size:10px;color:#888;letter-spacing:2px">LUXURY FITTED WARDROBES</div>' +
        '<div style="font-size:10px;color:#555;margin-top:6px">www.luxuryhouseonline.com<br>www.luxuryfittedwardrobes.com</div></div>' +
      '<div style="text-align:right">' +
        '<div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:2px">Bespoke Quotation</div>' +
        '<div style="font-size:22px;font-weight:bold;color:#c0392b;margin:4px 0">' + q.id + '</div>' +
        '<div style="font-size:11px;color:#555">Date: ' + q.date + ' | Valid 30 days</div>' +
        surveyorLine + '</div>' +
    '</div>' +
    '<div class="qp-section"><h3>Customer</h3>' +
      '<div class="qp-row"><span><strong>' + q.customer.name + '</strong></span><span>' + q.customer.email + '</span></div>' +
      '<div class="qp-row"><span>' + q.customer.address + '</span><span>' + q.customer.phone + '</span></div>' +
    '</div>' +
    '<div class="qp-section"><h3>Items &amp; Specification</h3>' + itemsHTML + '</div>' +
    '<div class="qp-section"><h3>Payment Summary</h3>' +
      discLine +
      '<div class="qp-row" style="font-weight:bold;font-size:14px"><span>Grand Total (inc. VAT)</span><span style="color:#c0392b;font-size:16px">\u00a3' + q.pricing.total.toLocaleString() + '</span></div>' +
      '<div class="qp-row" style="background:#fdf2f0;padding:7px 4px"><span style="color:#c0392b;font-weight:bold">Deposit Paid</span><span style="color:#c0392b;font-weight:bold">\u00a3' + q.depositActual.toLocaleString() + '</span></div>' +
      '<div class="qp-row" style="background:#fdf2f0;padding:7px 4px"><span style="font-weight:bold">Balance Due on Installation</span><span style="font-weight:bold">\u00a3' + bal.toLocaleString() + '</span></div>' +
      '<div class="qp-row"><span>Lead Time</span><span>' + q.leadTime + '</span></div>' +
      installLine +
    '</div>' +
    '<div class="qp-section"><h3>Agreement &amp; Signatures</h3>' +
      '<p style="font-size:11px;color:#555;margin-bottom:12px">By signing below, both parties confirm agreement to the specification above and the Terms &amp; Conditions.</p>' +
      '<div class="qp-sig-row">' +
        '<div><div style="font-size:10px;color:#888;margin-bottom:6px">Customer Signature</div>' + sigCustImg +
          '<div class="qp-sig-box"><strong>' + (q.sigCustomerName||'_________________________') + '</strong><br><span style="color:#aaa">Print Name</span><br><br>Date: ' + (q.sigCustomerDate||'___ / ___ / ________') + '<br></div></div>' +
        '<div><div style="font-size:10px;color:#888;margin-bottom:6px">Agent / Company Signature</div>' + sigAgentImg +
          '<div class="qp-sig-box"><strong>' + (q.sigAgentName||'_________________________') + '</strong><br><span style="color:#aaa">Print Name</span><br><br>Date: ' + q.date + '<br></div></div>' +
      '</div>' +
    '</div>' +
    '<div class="qp-tc"><strong>T&amp;C Summary:</strong> All bespoke furniture is made to order â€” non-refundable once manufacture commences. Deposit non-refundable. Balance due in full on installation day. 2-year workmanship warranty. 5-year structural warranty. Lead time: ' + q.leadTime + '. Quote valid 30 days.<br>Full terms: www.luxuryhouseonline.com/terms</div>' +
    '</div>';
}

function buildTextSpec(q) {
  const bal = Math.max(0, q.pricing.total - q.depositActual);
  const lines = (q.items||[]).map((item,i)=>{
    const col=item.customColour||(item.colour?item.colour.code+' '+item.colour.name+' ('+item.colour.brand+')':'â€”');
    const tot=item.basePrice+Math.round(item.basePrice*0.2);
    const acc=[...item.addons,...(item.customAddon?[item.customAddon]:[])].join(', ')||'None';
    return '\n--- Item '+(i+1)+': '+item.type+' â€” '+item.room+' ---'
      +'\nDimensions: '+item.w+'mm W Ã— '+item.h+'mm H Ã— '+item.d+'mm D (Ã—'+item.units+' unit'+(item.units>1?'s':'')+')'
      +'\nDoors: '+item.doors+' | Style: '+item.doorStyle+' | Finish: '+item.finish
      +'\nBoard: '+col
      +'\nHandles: '+item.handles
      +'\nInterior: '+item.rails+', '+item.shelves+' Shelves, '+item.drawers
      +'\nInterior Colour: '+item.interiorFinish
      +'\nAccessories: '+acc
      +(item.extraPrice?'\nAdditional Works: Â£'+parseFloat(item.extraPrice).toLocaleString():'')
      +(item.bespokeNotes?'\nNotes: '+item.bespokeNotes:'')
      +'\nItem Total: Â£'+tot.toLocaleString()+' inc. VAT';
  }).join('\n');
  return {lines, bal};
}

function sendEmail() {
  const q = collectData();
  const {lines, bal} = buildTextSpec(q);
  const subj = encodeURIComponent('Bespoke Quote '+q.id+' â€” Luxury House');
  const body = encodeURIComponent(
    'Dear '+q.customer.name+','
    +'\n\nThank you for choosing Luxury House / Luxury Fitted Wardrobes.'
    +'\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    +'\nQUOTE REF: '+q.id+'  |  DATE: '+q.date
    +'\nInstallation Address: '+q.customer.address
    +'\nAgent: '+(q.surveyor||'The Team')
    +'\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    +lines
    +'\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    +'\nGRAND TOTAL:           Â£'+q.pricing.total.toLocaleString()+' inc. VAT'
    +(q.pricing.disc?'\nDiscount Applied:      âˆ’Â£'+q.pricing.disc.toLocaleString():'')
    +'\nDeposit Paid:          Â£'+q.depositActual.toLocaleString()
    +'\nBalance on Install:    Â£'+bal.toLocaleString()
    +'\nLead Time:             '+q.leadTime
    +(q.installDate?'\nExpected Install Date: '+q.installDate:'')
    +'\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    +'\n\nThis quote is valid for 30 days. Full T&Cs apply.'
    +'\nwww.luxuryhouseonline.com | www.luxuryfittedwardrobes.com'
    +'\n\nWarm regards,\n'+(q.surveyor||'The Team')+'\nLuxury House | Luxury Fitted Wardrobes'
  );
  window.location.href = 'mailto:'+q.customer.email+'?subject='+subj+'&body='+body;
  toast('Opening email client...');
}

function sendWhatsapp() {
  const q = collectData();
  const {lines, bal} = buildTextSpec(q);
  const name = q.customer.name.split(' ')[0];
  const msg = encodeURIComponent(
    'Hi '+name+'! ğŸ‘‹'
    +'\n\n*Your Bespoke Quote from Luxury House*'
    +'\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
    +'\n*Quote Ref:* '+q.id+'  |  *Date:* '+q.date
    +'\n*Address:* '+q.customer.address
    +lines.replace(/---/g,'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
    +'\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
    +'\n*Grand Total:* Â£'+q.pricing.total.toLocaleString()+' inc. VAT'
    +(q.pricing.disc?'\n*Discount:* âˆ’Â£'+q.pricing.disc.toLocaleString():'')
    +'\n*Deposit Paid:* Â£'+q.depositActual.toLocaleString()
    +'\n*Balance on Install:* Â£'+bal.toLocaleString()
    +'\n*Lead Time:* '+q.leadTime
    +(q.installDate?'\n*Install Date:* '+q.installDate:'')
    +'\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
    +'\n\nQuote valid 30 days. T&Cs apply.'
    +'\nwww.luxuryhouseonline.com'
    +'\n\n_Luxury House | Luxury Fitted Wardrobes_ ğŸ '
  );
  window.open('https://wa.me/'+q.customer.phone.replace(/\D/g,'')+'?text='+msg, '_blank');
  toast('Opening WhatsApp...');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE ORDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveOrder() {
  if (!document.getElementById('tc-checkbox').checked) { toast('Please accept the Terms & Conditions first'); return; }
  const q = collectData();
  orders.push(q);
  localStorage.setItem('lh_v3_orders', JSON.stringify(orders));
  toast('Order ' + q.id + ' saved!');
  setTimeout(() => showPage('orders'), 1400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDERS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const statusClass = {'Quoted':'s-quoted','Deposit Taken':'s-deposit','In Manufacture':'s-manufacture','Delivery Scheduled':'s-delivery','Installed':'s-installed','Complete':'s-complete'};

function renderOrders() {
  const filter = document.getElementById('status-filter').value;
  const list = filter ? orders.filter(o=>o.status===filter) : orders;
  const el = document.getElementById('orders-list');
  if (!list.length) { el.innerHTML=`<div class="muted" style="text-align:center;padding:40px">${filter?'No orders with this status':'No orders yet'}</div>`; return; }
  el.innerHTML = list.slice().reverse().map(o => {
    const idx = orders.indexOf(o);
    const bal = Math.max(0, o.pricing.total-(o.depositActual||0));
    const summary = (o.items||[]).map(i=>`${i.type} â€” ${i.room}`).join(' Â· ');
    return `
    <div class="order-card" onclick="openOrderDetail(${idx})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="order-id">${o.id} Â· ${o.date} Â· ${o.surveyor||''}</div>
          <div class="order-name">${o.customer.address}</div>
          <div class="order-detail" style="color:var(--text-muted);font-size:12px">${o.customer.name} Â· ${o.customer.phone}</div>
          <div class="order-detail">${summary}</div>
          <div class="order-detail" style="margin-top:4px">
            ğŸ’° <strong>Â£${o.pricing.total.toLocaleString()}</strong> &nbsp;|&nbsp;
            âœ… Deposit: Â£${(o.depositActual||0).toLocaleString()} &nbsp;|&nbsp;
            ğŸ“‹ Balance: Â£${bal.toLocaleString()} &nbsp;|&nbsp;
            ğŸ“… ${o.installDate||'TBC'} Â· ${o.leadTime}
          </div>
        </div>
        <span class="status-badge ${statusClass[o.status]||'s-deposit'}">${o.status}</span>
      </div>
    </div>`;
  }).join('');
}

function openOrderDetail(idx) {
  var o = orders[idx];
  document.getElementById('modal-order-title').textContent = o.id + ' \u2014 ' + o.customer.address;
  var statuses = ['Quoted','Deposit Taken','In Manufacture','Delivery Scheduled','Installed','Complete'];
  var bal = Math.max(0, o.pricing.total-(o.depositActual||0));

  var itemsHTML = (o.items||[]).map(function(item, i) {
    var col = item.customColour || (item.colour ? item.colour.code + ' ' + item.colour.name + ' (' + item.colour.brand + ')' : '\u2014');
    var noteLine = item.bespokeNotes ? '<em style="color:var(--text-muted)">' + item.bespokeNotes + '</em>' : '';
    var sketchLine = item.sketchPNG ? '<img src="' + item.sketchPNG + '" style="width:100%;margin-top:6px;border-radius:6px;border:1px solid var(--border)">' : '';
    return '<div style="background:var(--black3);border-radius:8px;padding:10px;margin-bottom:8px;font-size:12px">' +
      '<strong style="color:var(--red-light)">Item ' + (i+1) + ': ' + item.room + ' \u2014 ' + item.type + '</strong><br>' +
      item.w + '\u00d7' + item.h + '\u00d7' + item.d + 'mm \u00b7 ' + item.doorStyle + ' \u00b7 ' + col + ' \u00b7 Interior: ' + item.interiorFinish + '<br>' +
      noteLine + sketchLine + '</div>';
  }).join('');

  var statusToggles = statuses.map(function(s) {
    return '<div class="toggle-opt' + (o.status===s?' selected':'') + '" onclick="updateStatus(' + idx + ',\'' + s + '\',this)">' + s + '</div>';
  }).join('');

  var notesHTML = (o.notes||[]).map(function(n) {
    return '<div style="padding:8px;background:var(--black3);border-radius:8px;margin-bottom:6px;font-size:12px"><span class="muted">' + n.date + '</span> \u2014 ' + n.text + '</div>';
  }).join('');

  var internalBox = o.internalNotes ? '<div style="background:rgba(243,156,18,0.08);border:1px solid rgba(243,156,18,0.3);border-radius:8px;padding:10px;margin-bottom:12px;font-size:12px;color:#f5b041"><strong>\uD83D\uDD12 Internal Notes:</strong> ' + o.internalNotes + '</div>' : '';

  document.getElementById('modal-order-body').innerHTML =
    '<div style="margin-bottom:14px">' +
      '<label style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted)">Update Status</label>' +
      '<div class="toggle-group" style="margin-top:7px" id="st-tog-' + idx + '">' + statusToggles + '</div>' +
    '</div>' +
    '<div class="divider"></div>' +
    '<div class="form-grid" style="gap:10px;margin-bottom:14px">' +
      '<div><div class="muted">Customer</div>' + o.customer.name + '<br><span class="muted">' + o.customer.email + '<br>' + o.customer.phone + '</span></div>' +
      '<div><div class="muted">Address</div>' + o.customer.address + '</div>' +
      '<div><div class="muted">Lead / Install</div>' + o.leadTime + ' \u00b7 ' + (o.installDate||'TBC') + '</div>' +
      '<div><div class="muted">Agent</div>' + (o.surveyor||'\u2014') + '</div>' +
    '</div>' +
    internalBox +
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">' +
      '<div style="background:var(--black3);border-radius:8px;padding:12px;text-align:center"><div class="muted" style="font-size:10px">TOTAL</div><div style="color:var(--red-light);font-size:18px;font-weight:bold">\u00a3' + o.pricing.total.toLocaleString() + '</div></div>' +
      '<div style="background:var(--black3);border-radius:8px;padding:12px;text-align:center"><div class="muted" style="font-size:10px">DEPOSIT PAID</div><div style="color:#58d68d;font-size:18px;font-weight:bold">\u00a3' + (o.depositActual||0).toLocaleString() + '</div></div>' +
      '<div style="background:var(--black3);border-radius:8px;padding:12px;text-align:center"><div class="muted" style="font-size:10px">BALANCE DUE</div><div style="color:var(--warning);font-size:18px;font-weight:bold">\u00a3' + bal.toLocaleString() + '</div></div>' +
    '</div>' +
    '<div style="margin-bottom:14px">' + itemsHTML + '</div>' +
    '<div class="divider"></div>' +
    '<div style="margin-bottom:10px">' +
      '<div class="muted" style="margin-bottom:6px;font-size:10px;letter-spacing:1px;text-transform:uppercase">Add Note</div>' +
      '<div style="display:flex;gap:8px"><input type="text" id="note-input-' + idx + '" placeholder="e.g. Panels ordered, delivery booked..."><button class="btn btn-red btn-sm" onclick="addNote(' + idx + ')">Add</button></div>' +
    '</div>' +
    '<div id="notes-list-' + idx + '">' + notesHTML + '</div>' +
    '<div class="divider"></div>' +
    '<div class="btn-row">' +
      '<button class="btn btn-dark btn-sm" onclick="printOrder(' + idx + ')">\uD83D\uDDA8\uFE0F Print A4</button>' +
      '<button class="btn btn-info btn-sm" onclick="emailOrder(' + idx + ')">\uD83D\uDCE7 Email Customer</button>' +
      '<button class="btn btn-whatsapp btn-sm" onclick="waOrder(' + idx + ')">\uD83D\uDCAC WhatsApp</button>' +
      '<button class="btn btn-dark btn-sm" onclick="emailMfg(' + idx + ')">\uD83C\uDFED Email Manufacturing</button>' +
      '<button class="btn btn-danger btn-sm" onclick="deleteOrder(' + idx + ')">\uD83D\uDDD1 Delete</button>' +
    '</div>';
  document.getElementById('modal-order').classList.add('open');
}
function updateStatus(idx, status, el) {
  const g = el.closest('.toggle-group');
  g.querySelectorAll('.toggle-opt').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  orders[idx].status = status;
  localStorage.setItem('lh_v3_orders', JSON.stringify(orders));
  renderOrders(); renderPipeline();
  toast('Status updated: ' + status);
}

function addNote(idx) {
  var input = document.getElementById('note-input-'+idx);
  var text = input.value.trim(); if (!text) return;
  if (!orders[idx].notes) orders[idx].notes=[];
  var note = {date:new Date().toLocaleString('en-GB'), text:text};
  orders[idx].notes.push(note);
  localStorage.setItem('lh_v3_orders', JSON.stringify(orders));
  document.getElementById('notes-list-'+idx).innerHTML += '<div style="padding:8px;background:var(--black3);border-radius:8px;margin-bottom:6px;font-size:12px"><span class="muted">'+note.date+'</span> â€” '+note.text+'</div>';
  input.value=''; toast('Note saved');
}

function deleteOrder(idx) {
  if (!confirm('Delete this order permanently?')) return;
  orders.splice(idx,1); localStorage.setItem('lh_v3_orders',JSON.stringify(orders));
  closeModal('modal-order'); renderOrders(); renderPipeline(); toast('Deleted');
}


function printOrder(idx) {
  const o = orders[idx];
  const html = buildQuoteHTML(o);
  document.getElementById('print-frame-content').innerHTML = html;
  document.getElementById('print-frame').style.display = 'block';
  document.getElementById('modal-order').classList.remove('open');
}

function closePrintFrame() {
  document.getElementById('print-frame').style.display = 'none';
}

function emailOrder(idx) {
  const o=orders[idx], bal=Math.max(0,o.pricing.total-(o.depositActual||0));
  const subj=encodeURIComponent(`Order Update â€” ${o.id} â€” Luxury House`);
  const body=encodeURIComponent(`Dear ${o.customer.name},\n\nYour order ${o.id} is now: ${o.status}.\n\nInstall Date: ${o.installDate||'TBC'}\nBalance Due: Â£${bal.toLocaleString()}\n\nKind regards,\n${o.surveyor||'The Team'}\nLuxury House`);
  window.location.href=`mailto:${o.customer.email}?subject=${subj}&body=${body}`;
}

function waOrder(idx) {
  const o=orders[idx], bal=Math.max(0,o.pricing.total-(o.depositActual||0));
  const name=o.customer.name.split(' ')[0];
  const itemLines=(o.items||[]).map((it,i)=>{
    const tot=it.basePrice+Math.round(it.basePrice*0.2);
    const col=it.customColour||(it.colour?it.colour.code+' '+it.colour.name:'â€”');
    return '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
      +'\n*Item '+(i+1)+':* '+it.type+' â€” '+it.room
      +'\n'+it.w+'mm W Ã— '+it.h+'mm H Ã— '+it.d+'mm D'
      +'\n'+it.doorStyle+' | '+it.finish+' | '+col
      +'\nInterior: '+it.rails+', '+it.shelves+' shelves'
      +(it.drawers&&it.drawers!=='No Drawers'?', '+it.drawers:'')
      +(it.bespokeNotes?'\nNotes: '+it.bespokeNotes:'')
      +'\n*Item Total:* Â£'+tot.toLocaleString()+' inc. VAT';
  }).join('');
  const msg=encodeURIComponent(
    'Hi '+name+'! ğŸ‘‹'
    +'\n\n*Order Update â€” Luxury House*'
    +'\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
    +'\n*Ref:* '+o.id+'  |  *Status:* '+o.status
    +'\n*Address:* '+o.customer.address
    +itemLines
    +'\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
    +'\n*Total:* Â£'+o.pricing.total.toLocaleString()+' inc. VAT'
    +'\n*Deposit:* Â£'+(o.depositActual||0).toLocaleString()
    +'\n*Balance Due:* Â£'+bal.toLocaleString()
    +'\n*Install Date:* '+(o.installDate||'TBC')
    +'\n*Lead Time:* '+o.leadTime
    +'\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
    +'\n\n_Luxury House | Luxury Fitted Wardrobes_ ğŸ '
    +'\nwww.luxuryhouseonline.com'
  );
  window.open('https://wa.me/'+o.customer.phone.replace(/\D/g,'')+'?text='+msg,'_blank');
}

function emailMfg(idx) {
  const o=orders[idx];
  const lines=(o.items||[]).map((item,i)=>`\nItem ${i+1}: ${item.type} â€” ${item.room}\n  ${item.w}x${item.h}x${item.d}mm x${item.units}\n  ${item.doorStyle}, ${item.finish}\n  Board: ${item.customColour||(item.colour?item.colour.code+' '+item.colour.name+' ('+item.colour.brand+')':'â€”')}\n  Handles: ${item.handles}\n  Rails: ${item.rails} | Shelves: ${item.shelves} | Drawers: ${item.drawers}\n  Interior colour: ${item.interiorFinish}\n  Accessories: ${item.addons.join(', ')||'None'}\n  Notes: ${item.bespokeNotes||'None'}`).join('\n');
  const subj=encodeURIComponent(`MANUFACTURING â€” ${o.id} â€” ${o.customer.name}`);
  const body=encodeURIComponent(`MANUFACTURING ORDER â€” Luxury House\n\nRef: ${o.id}\nCustomer: ${o.customer.name}\nAddress: ${o.customer.address}\nInstall: ${o.installDate||'TBC'}\nAgent: ${o.surveyor||'N/A'}\nLead Time: ${o.leadTime}\n${lines}\n\nOrdered: ${o.date}`);
  window.location.href=`mailto:manufacturing@luxuryhouseonline.com?subject=${subj}&body=${body}`;
  toast('Manufacturing email opened');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pipeStages=[{key:'Quoted',icon:'ğŸ“‹'},{key:'Deposit Taken',icon:'ğŸ’³'},{key:'In Manufacture',icon:'ğŸ”¨'},{key:'Delivery Scheduled',icon:'ğŸšš'},{key:'Installed',icon:'ğŸª'},{key:'Complete',icon:'âœ…'}];

function renderPipeline() {
  const total=orders.reduce((s,o)=>s+o.pricing.total,0);
  const outstanding=orders.filter(o=>o.status!=='Complete').reduce((s,o)=>s+Math.max(0,o.pricing.total-(o.depositActual||0)),0);
  document.getElementById('pipeline-summary').textContent=`${orders.length} orders Â· Â£${total.toLocaleString()} pipeline Â· Â£${outstanding.toLocaleString()} outstanding`;
  document.getElementById('pipeline-board').innerHTML = pipeStages.map(function(stage) {
    var so = orders.filter(function(o) { return o.status === stage.key; });
    var cards = so.map(function(o) {
      return '<div class="pipe-card" onclick="openOrderDetail(' + orders.indexOf(o) + ')">' +
        '<div style="font-weight:bold;margin-bottom:2px;font-size:11px">' + o.customer.address + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">' + o.customer.name + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">' + o.id + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">' + (o.items||[]).length + ' item' + ((o.items||[]).length!==1?'s':'') + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">\u00a3' + o.pricing.total.toLocaleString() + ' total</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">Bal: \u00a3' + Math.max(0,o.pricing.total-(o.depositActual||0)).toLocaleString() + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">\uD83D\uDCC5 ' + (o.installDate||'TBC') + '</div>' +
        '</div>';
    }).join('') || '<div style="font-size:11px;color:var(--border);padding:6px">Empty</div>';
    return '<div class="pipe-col">' +
      '<div class="pipe-col-title">' + stage.icon + ' ' + stage.key + ' (' + so.length + ')</div>' +
      cards +
      '<div style="font-size:10px;color:var(--text-muted);margin-top:6px">\u00a3' + so.reduce(function(s,o){return s+o.pricing.total;},0).toLocaleString() + '</div>' +
      '</div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
  if (name==='orders') renderOrders();
  if (name==='pipeline') renderPipeline();
  if (name==='quote') { items=[]; itemCounter=0; currentStep=1; goStep(1); }
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let toastTimer;
function toast(msg) {
  const el=document.getElementById('toast');
  el.textContent=msg; el.style.display='block';
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.style.display='none',3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAMPLE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (orders.length===0) {
  orders.push({
    id:'LH-001',date:'14/02/2025',
    customer:{name:'Sarah Thompson',email:'sarah@example.com',phone:'+44 7700 112233',address:'45 Oak Avenue, Surrey, KT6 4AB'},
    surveyor:'Mark Davies',internalNotes:'Customer agreed Â£1,000 deposit. Paying remainder 2 weeks before install.',
    items:[
      {id:1,type:'Sliding Door Fitted',room:'Master Bedroom',doors:'4 Door',w:'3200',h:'2260',d:'600',units:1,doorStyle:'Handleless',finish:'Matt',colour:{code:'U708',name:'Light Grey',brand:'Egger',hex:'#c8c8c8'},customColour:'',handles:'None / Handleless',rails:'Double Hang',shelves:6,drawers:'4 Drawers',addons:['LED Lighting','Soft-Close'],interiorFinish:'White',bespokeNotes:'Slight slope on left â€” 40mm drop over 3.2m.',extraPrice:0,sketchHistory:[],sketchPNG:null,basePrice:7731},
      {id:2,type:'Hinged Door Fitted',room:'Bedroom 2',doors:'2 Door',w:'1800',h:'2260',d:'580',units:1,doorStyle:'Shaker',finish:'Matt',colour:{code:'W1000',name:'Alpine White',brand:'Egger',hex:'#f8f8f8'},customColour:'',handles:'Matt Black',rails:'Long Hang (Full Height)',shelves:3,drawers:'No Drawers',addons:[],interiorFinish:'White',bespokeNotes:'',extraPrice:0,sketchHistory:[],sketchPNG:null,basePrice:3240}
    ],
    pricing:{total:13166,rec:6583,disc:0},depositActual:1000,
    paymentMethod:'Bank Transfer',leadTime:'8â€“10 Weeks',installDate:'2025-04-28',
    sigCustomerPNG:null,sigAgentPNG:null,sigCustomerName:'Sarah Thompson',sigAgentName:'Mark Davies',
    status:'In Manufacture',notes:[{date:'15/02/2025, 09:30',text:'Order confirmed. Â£1,000 deposit taken. Sent to manufacturing.'}]
  });
  orders.push({
    id:'LH-002',date:'18/02/2025',
    customer:{name:'James Mitchell',email:'james@example.com',phone:'+44 7711 445566',address:'12 Manor Road, London, SW1A 1AA'},
    surveyor:'Claire Hobbs',internalNotes:'VIP â€” referred by the Andersons. Only paid Â£500 today, will pay more next week.',
    items:[
      {id:1,type:'Walk-In Wardrobe',room:'Dressing Room',doors:'Open / No Doors',w:'4800',h:'2260',d:'600',units:2,doorStyle:'Handleless',finish:'High Gloss',colour:{code:'U999',name:'Black',brand:'Egger',hex:'#111111'},customColour:'',handles:'Brushed Gold',rails:'Half & Half',shelves:12,drawers:'Full Drawer Bank',addons:['LED Lighting','Pull-Out Mirror','Shoe Racks','Soft-Close'],interiorFinish:'Matching',bespokeNotes:'Island unit in centre â€” 1200x600mm, 6 drawers.',extraPrice:1200,sketchHistory:[],sketchPNG:null,basePrice:18955}
    ],
    pricing:{total:22746,rec:11373,disc:0},depositActual:500,
    paymentMethod:'Card (payment link)',leadTime:'10â€“12 Weeks',installDate:'2025-05-12',
    sigCustomerPNG:null,sigAgentPNG:null,sigCustomerName:'James Mitchell',sigAgentName:'Claire Hobbs',
    status:'Deposit Taken',notes:[{date:'18/02/2025, 16:00',text:'Â£500 deposit taken on day. Customer paying further Â£5,000 next week.'}]
  });
  localStorage.setItem('lh_v3_orders',JSON.stringify(orders));
}
</script>
<div id="print-frame">
  <div id="print-frame-inner">
    <div class="print-toolbar no-print">
      <button onclick="window.print()" style="padding:8px 18px;background:#c0392b;color:#fff;border:none;border-radius:7px;cursor:pointer;font-size:13px;font-weight:bold">ğŸ–¨ï¸ Print / Save PDF</button>
      <button onclick="closePrintFrame()" style="padding:8px 14px;background:#eee;color:#333;border:none;border-radius:7px;cursor:pointer;font-size:13px">âœ• Close</button>
    </div>
    <div id="print-frame-content"></div>
  </div>
</div>
</body>
</html>
